import{r as v,j as e,v as M,ak as $}from"./index-CfFwh--H.js";import{N as w,t as A}from"./toast-CZz_7xZu.js";import{F as T,a as u}from"./FormItem-CrM3E5oZ.js";import{B as I}from"./Button-DK8YG6Vd.js";import{S as V}from"./StickyFooter-DkUgER91.js";import{F as z,a as L,b}from"./formik.esm-L7JVMBJt.js";import{A as J}from"./index-rtDifbQS.js";import{$ as R}from"./index-CEOENyZN.js";import{c as U,e as G,b as O,g as q,f as H}from"./index.esm-CDTj4fG4.js";import"./Alert-8oOn-LBQ.js";import"./index-CSFznbuf.js";import"./Badge-Bo_BJ3HY.js";import{D as _}from"./index-Tb9TnHR2.js";import"./Card-DrR7Wowt.js";import"./Skeleton-CkbmhpF1.js";import"./Dialog-CCGqt-e6.js";import"./Drawer-rdVC219j.js";import"./index-Cqj_MPfk.js";import"./useUniqueId-C3QGMlyo.js";import{I as j}from"./Input-CT3ndZ0a.js";import"./index-e68N8ix-.js";import"./index-DuV_W8Ok.js";import"./index-BhqUyqjr.js";import"./index-DbLmEKzF.js";import"./ScrollBar-BGjE3Qe3.js";import"./Select-DXgitA5g.js";import"./Upload-C3hi9liu.js";import"./index-uPavB4wA.js";import"./Tag-CDky4RgO.js";import{A as F}from"./AdaptableCard-T1jSCi4m.js";import"./Views-DDo_d-60.js";import"./chart.config-46MU3zdR.js";import"./DataTable-B06t5ZtT.js";import"./SvgIcon-r4E3aiGi.js";import"./SegmentItemOption-BO4J9Vay.js";import{E as K,F as Q,G as W}from"./api-BL2eMQch.js";import"./StatusIcon-CVY_iJbr.js";import"./CloseButton-BXsrAn2U.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-DVFC3BrG.js";import"./context-ClB8cHxu.js";import"./index-CbqZmROt.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-ByyYtpKF.js";import"./floating-ui.react-DGPs_AnH.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-e9pFJmGN.js";import"./_getPrototype-QbS_EcaU.js";import"./index-C6dvUS2c.js";import"./toString-tgkm5ft3.js";import"./index-DYO9xx5Q.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-LGebAmfn.js";import"./index-WfMoUKkC.js";import"./useThemeClass-Rhgp5cBq.js";const X=new Date,B=v.forwardRef((f,l)=>{const{type:y,initialData:n={projectName:"",poNumber:"",startDate:new Date,budget:0,expenses:0,profit:0,description:"",attachments:[]},onFormSubmit:E,onDiscard:h,onDelete:N}=f,D=U().shape({projectName:O().required("Project name is required").max(100,"Project name must be at most 100 characters"),poNumber:O().max(50,"PO number must be at most 50 characters"),startDate:H().required("Project start date is required").typeError("Please select a valid date"),budget:q().required("Budget is required").positive("Budget must be positive").typeError("Budget must be a number"),expenses:q().required("Expenses are required").positive("Expenses must be positive").typeError("Expenses must be a number"),profit:q().required("Profit is required").typeError("Profit must be a number"),description:O().max(500,"Description must be at most 500 characters"),attachments:G().max(5,"Maximum 5 attachments allowed")}),S=(s,t)=>{if(s.target.files){const a=Array.from(s.target.files);t("attachments",[...n.attachments||[],...a])}},k=(s,t,a)=>{const d=[...t.attachments];d.splice(s,1),a("attachments",d)};return e.jsx(z,{innerRef:l,initialValues:{projectName:n.projectName||"",poNumber:n.poNumber||"",startDate:n.startDate instanceof Date?n.startDate:new Date(n.startDate),budget:n.budget||0,expenses:n.expenses||0,profit:n.profit||0,description:n.description||"",attachments:n.attachments||[]},validationSchema:D,onSubmit:async(s,{setSubmitting:t,setErrors:a,resetForm:d})=>{var p,x;try{await E(s,t)}catch(i){t(!1),(x=(p=i.response)==null?void 0:p.data)!=null&&x.errors&&a(i.response.data.errors),console.error("Form submission error:",i)}},enableReinitialize:!0,children:({values:s,touched:t,errors:a,isSubmitting:d,setFieldValue:p,handleBlur:x,resetForm:i})=>e.jsx(L,{children:e.jsxs(T,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(F,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Project Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4",children:[e.jsx(u,{label:"Project Name",invalid:!!a.projectName&&t.projectName,errorMessage:a.projectName,children:e.jsx(b,{name:"projectName",children:({field:r})=>e.jsx(j,{autoComplete:"off",placeholder:"Enter project name",...r})})}),e.jsx(u,{label:"PO Number",invalid:!!a.poNumber&&t.poNumber,errorMessage:a.poNumber,children:e.jsx(b,{name:"poNumber",children:({field:r})=>e.jsx(j,{autoComplete:"off",placeholder:"Enter PO number",...r})})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx(u,{label:"Start Date",invalid:!!a.startDate&&t.startDate,errorMessage:a.startDate,children:e.jsx(b,{name:"startDate",children:({field:r,form:o})=>{const c=r.value&&!isNaN(new Date(r.value).getTime())?new Date(r.value):null;return e.jsx(_,{placeholder:"Select Start Date",value:c,maxDate:X,onChange:m=>o.setFieldValue(r.name,m||null)})}})})})]}),e.jsxs(F,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Financial Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(u,{label:"Budget",invalid:!!a.budget&&t.budget,errorMessage:a.budget,children:e.jsx(b,{name:"budget",children:({field:r,form:o})=>e.jsx(j,{type:"number",autoComplete:"off",placeholder:"Budget",...r,onChange:c=>{o.setFieldValue(r.name,c.target.value);const m=parseFloat(c.target.value)||0,g=parseFloat(s.expenses)||0,C=m-g;o.setFieldValue("profit",C)}})})}),e.jsx(u,{label:"Expenses",invalid:!!a.expenses&&t.expenses,errorMessage:a.expenses,children:e.jsx(b,{name:"expenses",children:({field:r,form:o})=>e.jsx(j,{type:"number",autoComplete:"off",placeholder:"Expenses",...r,onChange:c=>{o.setFieldValue(r.name,c.target.value);const m=parseFloat(s.budget)||0,g=parseFloat(c.target.value)||0,C=m-g;o.setFieldValue("profit",C)}})})}),e.jsx(u,{label:"Profit",invalid:!!a.profit&&t.profit,errorMessage:a.profit,children:e.jsx(b,{name:"profit",children:({field:r,form:o})=>e.jsx(j,{type:"number",autoComplete:"off",placeholder:"Profit",...r,readOnly:!0})})})]})]}),e.jsxs(F,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Project Details"}),e.jsx(u,{label:"Description",invalid:!!a.description&&t.description,errorMessage:a.description,children:e.jsx(b,{name:"description",children:({field:r})=>e.jsx(j,{as:"textarea",autoComplete:"off",placeholder:"Enter project description",...r})})})]}),e.jsxs(F,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(u,{label:"Attachments",invalid:!!a.attachments&&t.attachments,errorMessage:a.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:r=>S(r,p),onBlur:()=>x({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"},s.attachments.length)}),s.attachments.length>0&&e.jsx("div",{className:"space-y-2",children:s.attachments.map((r,o)=>{const c=r instanceof File,m=c?r.name:r.fileName,g=c?void 0:r.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[g?e.jsx("a",{href:g,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:m}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:m}),e.jsx("button",{type:"button",onClick:()=>k(o,s,p),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(R,{})})]},o)})})]})]})]})}),e.jsxs(V,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:y==="edit"&&N&&e.jsx(I,{size:"sm",variant:"plain",color:"red",icon:e.jsx(R,{}),type:"button",onClick:()=>N(r=>{r&&i()}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(I,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>{i(),h==null||h()},children:"Discard"}),e.jsx(I,{size:"sm",variant:"solid",loading:d,icon:e.jsx(J,{}),type:"submit",children:"Save"})]})]})]})})})});B.displayName="ProfitAndLossForm";const P={reportDate:new Date().toISOString().split("T")[0],projectName:"",poNumber:"",startDate:"",budget:"",expenses:"",profit:"",description:"",attachments:[]},et=()=>{const f=M(),{id:l}=$(),[y,n]=v.useState(P),[E,h]=v.useState(!!l),[N,D]=v.useState(null);v.useEffect(()=>{if(!l){n(P),h(!1);return}(async()=>{try{h(!0);const t=await K(l);if(!(t!=null&&t.data))throw new Error("Invalid report data received");n({reportDate:t.data.reportDate||P.reportDate,projectName:t.data.projectName||"",poNumber:t.data.poNumber||"",startDate:t.data.startDate||"",budget:t.data.budget||"",expenses:t.data.expenses||"",profit:t.data.profit||"",description:t.data.description||"",attachments:t.data.attachments||[]}),D(null)}catch(t){console.error("Error fetching profit and loss report:",t),D(t.message||"Failed to load report data"),A.push(e.jsx(w,{title:"Failed to fetch profit and loss report data",type:"danger",duration:2500,children:t.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>f("/app/profit-loss-view"),2500)}finally{h(!1)}})()},[l,f]);const S=async(s,t)=>{var a,d,p,x;try{t(!0);const i=new FormData;i.append("reportType","profit-loss"),Object.keys(s).forEach(o=>{o!=="attachments"&&i.append(o,s[o])}),s.attachments&&s.attachments.length>0&&s.attachments.forEach((o,c)=>{o instanceof File&&i.append("attachments",o)}),s.reportDate instanceof Date&&i.set("reportDate",s.reportDate.toISOString()),s.startDate instanceof Date&&i.set("startDate",s.startDate.toISOString());const r=l?await Q(l,i):await W(i);if([200,201].includes(r.status))A.push(e.jsxs(w,{title:`Successfully ${l?"updated":"added"} profit report`,type:"success",duration:2500,children:["Profit and loss report ",l?"updated":"added"," successfully"]}),{placement:"top-center"}),f("/app/profit-and-loss-report-view");else throw new Error(((d=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:d.message)||"Unexpected status code")}catch(i){console.error("Error during form submission:",i),A.push(e.jsx(w,{title:`Error ${l?"updating":"adding"} profit and loss report`,type:"danger",duration:2500,children:((x=(p=i==null?void 0:i.response)==null?void 0:p.data)==null?void 0:x.message)||i.message}),{placement:"top-center"})}finally{t(!1)}},k=()=>{JSON.stringify(y)!==JSON.stringify(P)?window.confirm("Are you sure you want to discard changes?")&&f("/app/profit-loss-view"):f("/app/profit-loss-view")};return E?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):N?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(w,{title:"Error loading profit and loss report",type:"danger",children:N})}):e.jsx(B,{type:l?"edit":"new",initialData:y,onFormSubmit:S,onDiscard:k})};export{et as default};
