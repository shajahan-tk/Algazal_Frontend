import{r as B,v as ye,ak as je,Y as ge,j as e}from"./index-CDUqAS1l.js";import{F as fe,a as o}from"./FormItem-ByEmqHQ5.js";import{B as N}from"./Button-BPBskG9o.js";import{S as De}from"./StickyFooter-DBlfAIlK.js";import{F as xe,a as qe,b as u,c as _}from"./formik.esm-D7-nrDq7.js";import{c as L,e as W,b as F,f as I,g as $,d as R}from"./index.esm-OMRqgHjV.js";import{t as z,N as T}from"./toast-DGerJIJB.js";import{A as Q}from"./AdaptableCard-BXZ7gMWR.js";import{I as c}from"./Input-DXBk0KXn.js";import{$ as V,a0 as H}from"./index-BerpkDBA.js";import{D as Y}from"./index-CRkWz9hY.js";import{S as Ce}from"./Select-Bc7Wf5rB.js";import{f as Ae,e as ve,c as Ee}from"./api-BJ-aVY9j.js";import"./context-D-kJGxG9.js";import"./index-CJy_8sJq.js";import"./proxy-Dk6QltiT.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BmYztAKh.js";import"./StatusIcon-twe9Eqr7.js";import"./CloseButton-BXRa_ZJ2.js";import"./chainedFunction-BxZSneMW.js";import"./Card-Bb8Omztx.js";import"./Views-DmS3tele.js";import"./toString-DOI2nrr_.js";import"./useControllableState-DyX12gyY.js";import"./floating-ui.react-CCBWD0pR.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useUniqueId-CQBDBfVD.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";const ke=L().shape({dateOfEstimation:I().required("Estimation Date is required"),workStartDate:I().required("Work Start Date is required").min(R("dateOfEstimation"),"Work Start Date cannot be before Estimation Date"),workEndDate:I().required("Work End Date is required").min(R("workStartDate"),"Work End Date cannot be before Work Start Date"),validUntil:I().required("Valid Until Date is required").min(R("dateOfEstimation"),"Valid Until Date cannot be before Estimation Date"),paymentDueBy:F().required("Payment Due is required"),status:F().required("Status is required"),subject:F().required("subject is required"),materials:W().of(L().shape({description:F().required("Material name is required"),uom:F().required("Unit of measurement is required"),quantity:$().required("Quantity is required").min(0,"Quantity must be positive").typeError("Quantity must be a number"),unitPrice:$().required("Unit price is required").min(0,"Unit price must be positive").typeError("Unit price must be a number")})),labourCharges:W().of(L().shape({designation:F().required("Designation is required"),days:$().required("Days is required").min(0,"Days must be positive").typeError("Days must be a number"),price:$().required("Price is required").min(0,"Price must be positive").typeError("Price must be a number")})),termsAndConditions:W().of(L().shape({description:F().required("Description is required"),quantity:$().required("Quantity is required").min(0,"Quantity must be positive").typeError("Quantity must be a number"),unitPrice:$().required("Unit price is required").min(0,"Unit price must be positive").typeError("Unit price must be a number")}))}),ie=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"sq_m",label:"Square Meter (m²)"},{value:"sq_cm",label:"Square Centimeter (cm²)"},{value:"sq_mm",label:"Square Millimeter (mm²)"},{value:"sq_km",label:"Square Kilometer (km²)"},{value:"sq_in",label:"Square Inch (in²)"},{value:"sq_ft",label:"Square Foot (ft²)"},{value:"sq_yd",label:"Square Yard (yd²)"},{value:"acre",label:"Acre"},{value:"hectare",label:"Hectare (ha)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],we=B.forwardRef((re,ne)=>{const{onDiscard:se}=re,oe=ye(),G=je(),{state:Se}=ge();console.log("paramsData",G);const{projectId:le,estimationId:h}=G,[me,de]=B.useState({dateOfEstimation:new Date,workStartDate:new Date,workEndDate:new Date(Date.now()+7*24*60*60*1e3),validUntil:new Date(Date.now()+30*24*60*60*1e3),paymentDueBy:"",status:"Draft",materials:[{description:"",uom:"",quantity:0,unitPrice:0,total:0}],labourCharges:[{designation:"",days:0,price:0,total:0}],termsAndConditions:[{description:"",quantity:0,unitPrice:0,total:0}],estimatedAmount:0,subject:""}),[ce,ue]=B.useState(!!h);B.useEffect(()=>{(async()=>{if(h)try{const i=(await Ae(h)).data;de({dateOfEstimation:new Date(i.createdAt),workStartDate:new Date(i.workStartDate),workEndDate:new Date(i.workEndDate),validUntil:new Date(i.validUntil),paymentDueBy:i.paymentDueBy.toString(),status:i.status||"Draft",materials:i.materials.map(m=>({description:m.description,uom:m.uom,quantity:m.quantity,unitPrice:m.unitPrice,total:m.total})),labourCharges:i.labour.map(m=>({designation:m.designation,days:m.days,price:m.price,total:m.total})),termsAndConditions:i.termsAndConditions.map(m=>({description:m.description,quantity:m.quantity,unitPrice:m.unitPrice,total:m.total})),estimatedAmount:i.estimatedAmount,quotationAmount:i.quotationAmount,commissionAmount:i.commissionAmount,profit:i.profit,project:i.project._id,subject:i==null?void 0:i.subject})}catch(s){console.error("Error fetching estimation:",s),z.push(e.jsx(T,{title:"Error",type:"danger",duration:2500,children:"Failed to load estimation data."}),{placement:"top-center"})}finally{ue(!1)}})()},[h]);const pe=async t=>{try{h?(await ve(h,{project:t.project,paymentDueBy:t.paymentDueBy,termsAndConditions:t.termsAndConditions,validUntil:t.validUntil,materials:t.materials,labour:t.labourCharges,workEndDate:t.workEndDate,workStartDate:t.workStartDate,commissionAmount:t.commissionAmount,quotationAmount:t.quotationAmount,status:t.status,subject:t.subject}),z.push(e.jsx(T,{title:"Estimation Updated",type:"success",duration:2500,children:"Estimation updated successfully."}),{placement:"top-center"})):(await Ee({project:le,paymentDueBy:t.paymentDueBy,termsAndConditions:t.termsAndConditions,validUntil:t.validUntil,materials:t.materials,labour:t.labourCharges,workEndDate:t.workEndDate,workStartDate:t.workStartDate,commissionAmount:t.commissionAmount,quotationAmount:t.quotationAmount,subject:t.subject}),z.push(e.jsx(T,{title:"Estimation Created",type:"success",duration:2500,children:"Estimation created successfully."}),{placement:"top-center"})),oe(-1)}catch(s){console.error(`Error ${h?"updating":"creating"} estimation:`,s),(s==null?void 0:s.status)===400?z.push(e.jsx(T,{title:`Not ${h?"Updated":"Created"}`,type:"danger",duration:2500,children:h?"Failed to update estimation":"Only one estimation is allowed per project."}),{placement:"top-center"}):z.push(e.jsxs(T,{title:"Error",type:"danger",duration:2500,children:["Failed to ",h?"update":"create"," estimation. Please try again."]}),{placement:"top-center"})}};return ce?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(xe,{innerRef:ne,initialValues:me,validationSchema:ke,onSubmit:pe,enableReinitialize:!0,children:({values:t,touched:s,errors:i,isSubmitting:m,setFieldValue:M,handleChange:be})=>{B.useEffect(()=>{t.materials.forEach((r,n)=>{const d=parseFloat((r.quantity*r.unitPrice).toFixed(2));r.total!==d&&M(`materials[${n}].total`,d)}),t.labourCharges.forEach((r,n)=>{const d=parseFloat((r.days*r.price).toFixed(2));r.total!==d&&M(`labourCharges[${n}].total`,d)}),t.termsAndConditions.forEach((r,n)=>{const d=parseFloat((r.quantity*r.unitPrice).toFixed(2));r.total!==d&&M(`termsAndConditions[${n}].total`,d)});const l=t.materials.reduce((r,n)=>r+n.quantity*n.unitPrice,0),p=t.labourCharges.reduce((r,n)=>r+n.days*n.price,0),b=t.termsAndConditions.reduce((r,n)=>r+n.quantity*n.unitPrice,0),a=parseFloat((l+p+b).toFixed(2));if(t.estimatedAmount!==a&&M("estimatedAmount",a),t.quotationAmount!==void 0&&t.commissionAmount!==void 0){const r=parseFloat((t.quotationAmount-a-t.commissionAmount).toFixed(2));t.profit!==r&&M("profit",r)}},[t.materials,t.labourCharges,t.termsAndConditions,t.quotationAmount,t.commissionAmount]);const U=l=>{be(l);const{name:p,value:b}=l.target;M(p,parseFloat(b)||0)};return e.jsx(qe,{children:e.jsxs(fe,{children:[e.jsxs(Q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Work Details"}),e.jsx("p",{className:"mb-6",children:"Section to configure client and work information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(o,{label:"Work Start Date *",invalid:!!i.workStartDate&&s.workStartDate,errorMessage:i.workStartDate,children:e.jsx(u,{name:"workStartDate",children:({field:l,form:p})=>e.jsx(Y,{placeholder:"Select date",value:l.value,onChange:b=>{p.setFieldValue(l.name,b)},minDate:t.dateOfEstimation})})}),e.jsx(o,{label:"Work End Date *",invalid:!!i.workEndDate&&s.workEndDate,errorMessage:i.workEndDate,children:e.jsx(u,{name:"workEndDate",children:({field:l,form:p})=>e.jsx(Y,{placeholder:"Select date",value:l.value,onChange:b=>{p.setFieldValue(l.name,b)},minDate:t.workStartDate})})}),e.jsx(o,{label:"Valid Until *",invalid:!!i.validUntil&&s.validUntil,errorMessage:i.validUntil,children:e.jsx(u,{name:"validUntil",children:({field:l,form:p})=>e.jsx(Y,{placeholder:"Select date",value:l.value,onChange:b=>{p.setFieldValue(l.name,b)},minDate:t.dateOfEstimation})})}),e.jsx(o,{label:"Payment Due By *",invalid:!!i.paymentDueBy&&s.paymentDueBy,errorMessage:i.paymentDueBy,children:e.jsx(u,{type:"number",name:"paymentDueBy",placeholder:"paymentDueBy",component:c})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx(o,{label:"Subject",children:e.jsx(u,{type:"text",name:"subject",value:t.subject,placeholder:"Subject",textArea:!0,component:c})})})]}),e.jsxs(Q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Materials"}),e.jsx("p",{className:"mb-6",children:"List of materials required for the project"}),e.jsx(_,{name:"materials",children:({push:l,remove:p})=>e.jsxs("div",{className:"space-y-4",children:[t.materials.map((b,a)=>{var r,n,d,y,j,g,f,D,x,q,C,A,v,E,k,w,S,P,K,J,X,Z,ee,te;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[e.jsx(o,{label:`Material ${a+1}`,invalid:!!((n=(r=i.materials)==null?void 0:r[a])!=null&&n.description)&&((y=(d=s.materials)==null?void 0:d[a])==null?void 0:y.description),errorMessage:(g=(j=i.materials)==null?void 0:j[a])==null?void 0:g.description,children:e.jsx(u,{type:"text",name:`materials[${a}].description`,placeholder:"Material name",component:c})}),e.jsx(o,{label:"UOM",invalid:!!((D=(f=i.materials)==null?void 0:f[a])!=null&&D.uom)&&((q=(x=s.materials)==null?void 0:x[a])==null?void 0:q.uom),errorMessage:(A=(C=i.materials)==null?void 0:C[a])==null?void 0:A.uom,children:e.jsx(u,{name:`materials[${a}].uom`,children:({field:ae,form:he})=>e.jsx(Ce,{options:ie,value:ie.find(O=>O.value===ae.value)||null,onChange:O=>{he.setFieldValue(ae.name,(O==null?void 0:O.value)||"")},placeholder:"Select unit"})})}),e.jsx(o,{label:"Quantity",invalid:!!((E=(v=i.materials)==null?void 0:v[a])!=null&&E.quantity)&&((w=(k=s.materials)==null?void 0:k[a])==null?void 0:w.quantity),errorMessage:(P=(S=i.materials)==null?void 0:S[a])==null?void 0:P.quantity,children:e.jsx(u,{type:"number",name:`materials[${a}].quantity`,placeholder:"Quantity",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Unit Price",invalid:!!((J=(K=i.materials)==null?void 0:K[a])!=null&&J.unitPrice)&&((Z=(X=s.materials)==null?void 0:X[a])==null?void 0:Z.unitPrice),errorMessage:(te=(ee=i.materials)==null?void 0:ee[a])==null?void 0:te.unitPrice,children:e.jsx(u,{type:"number",name:`materials[${a}].unitPrice`,placeholder:"Unit price",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Total",children:e.jsx(c,{readOnly:!0,value:b.total,placeholder:"Total"})}),e.jsx("div",{className:"flex justify-end",children:t.materials.length>1&&e.jsx(N,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(V,{}),onClick:()=>p(a)})})]},a)}),e.jsx(N,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(H,{}),onClick:()=>l({description:"",uom:"",quantity:0,unitPrice:0,total:0}),children:"Add Material"})]})})]}),e.jsxs(Q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Labour Charges"}),e.jsx("p",{className:"mb-6",children:"List of labour charges for the project"}),e.jsx(_,{name:"labourCharges",children:({push:l,remove:p})=>e.jsxs("div",{className:"space-y-4",children:[t.labourCharges.map((b,a)=>{var r,n,d,y,j,g,f,D,x,q,C,A,v,E,k,w,S,P;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[e.jsx(o,{label:`Designation ${a+1}`,invalid:!!((n=(r=i.labourCharges)==null?void 0:r[a])!=null&&n.designation)&&((y=(d=s.labourCharges)==null?void 0:d[a])==null?void 0:y.designation),errorMessage:(g=(j=i.labourCharges)==null?void 0:j[a])==null?void 0:g.designation,children:e.jsx(u,{type:"text",name:`labourCharges[${a}].designation`,placeholder:"Designation",component:c})}),e.jsx(o,{label:"Days",invalid:!!((D=(f=i.labourCharges)==null?void 0:f[a])!=null&&D.days)&&((q=(x=s.labourCharges)==null?void 0:x[a])==null?void 0:q.days),errorMessage:(A=(C=i.labourCharges)==null?void 0:C[a])==null?void 0:A.days,children:e.jsx(u,{type:"number",name:`labourCharges[${a}].days`,placeholder:"Days",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Price",invalid:!!((E=(v=i.labourCharges)==null?void 0:v[a])!=null&&E.price)&&((w=(k=s.labourCharges)==null?void 0:k[a])==null?void 0:w.price),errorMessage:(P=(S=i.labourCharges)==null?void 0:S[a])==null?void 0:P.price,children:e.jsx(u,{type:"number",name:`labourCharges[${a}].price`,placeholder:"Price per day",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Total",children:e.jsx(c,{readOnly:!0,value:b.total,placeholder:"Total"})}),e.jsx("div",{className:"flex justify-end",children:t.labourCharges.length>1&&e.jsx(N,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(V,{}),onClick:()=>p(a)})})]},a)}),e.jsx(N,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(H,{}),onClick:()=>l({designation:"",days:0,price:0,total:0}),children:"Add Labour Charge"})]})})]}),e.jsxs(Q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx("p",{className:"mb-6",children:"Additional terms and conditions for the project"}),e.jsx(_,{name:"termsAndConditions",children:({push:l,remove:p})=>e.jsxs("div",{className:"space-y-4",children:[t.termsAndConditions.map((b,a)=>{var r,n,d,y,j,g,f,D,x,q,C,A,v,E,k,w,S,P;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[e.jsx(o,{label:`Description ${a+1}`,invalid:!!((n=(r=i.termsAndConditions)==null?void 0:r[a])!=null&&n.description)&&((y=(d=s.termsAndConditions)==null?void 0:d[a])==null?void 0:y.description),errorMessage:(g=(j=i.termsAndConditions)==null?void 0:j[a])==null?void 0:g.description,children:e.jsx(u,{type:"text",name:`termsAndConditions[${a}].description`,placeholder:"Description",component:c})}),e.jsx(o,{label:"Quantity",invalid:!!((D=(f=i.termsAndConditions)==null?void 0:f[a])!=null&&D.quantity)&&((q=(x=s.termsAndConditions)==null?void 0:x[a])==null?void 0:q.quantity),errorMessage:(A=(C=i.termsAndConditions)==null?void 0:C[a])==null?void 0:A.quantity,children:e.jsx(u,{type:"number",name:`termsAndConditions[${a}].quantity`,placeholder:"Quantity",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Unit Price",invalid:!!((E=(v=i.termsAndConditions)==null?void 0:v[a])!=null&&E.unitPrice)&&((w=(k=s.termsAndConditions)==null?void 0:k[a])==null?void 0:w.unitPrice),errorMessage:(P=(S=i.termsAndConditions)==null?void 0:S[a])==null?void 0:P.unitPrice,children:e.jsx(u,{type:"number",name:`termsAndConditions[${a}].unitPrice`,placeholder:"Unit price",component:c,min:0,step:"0.01",onChange:U})}),e.jsx(o,{label:"Total",children:e.jsx(c,{readOnly:!0,value:b.total,placeholder:"Total"})}),e.jsx("div",{className:"flex justify-end",children:t.termsAndConditions.length>1&&e.jsx(N,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(V,{}),onClick:()=>p(a)})})]},a)}),e.jsx(N,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(H,{}),onClick:()=>l({description:"",quantity:0,unitPrice:0,total:0}),children:"Add Term"})]})})]}),e.jsxs(Q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Summary"}),e.jsx("p",{className:"mb-6",children:"Final amounts and approvals"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsx(o,{label:"Estimated Amount",children:e.jsx(c,{readOnly:!0,name:"estimatedAmount",value:t.estimatedAmount,placeholder:"Estimated amount"})}),e.jsx(o,{label:"Commission Amount (Optional)",children:e.jsx(u,{type:"number",name:"commissionAmount",placeholder:"Commission amount",component:c,min:0,step:"0.01",onChange:U})}),t.quotationAmount!==void 0&&t.commissionAmount!==void 0&&e.jsx(o,{label:"Profit",children:e.jsx(c,{readOnly:!0,name:"profit",value:t.profit||0,placeholder:"Profit"})})]})]}),e.jsxs(De,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(N,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:se,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx("div",{className:"md:flex",children:e.jsx(N,{size:"sm",variant:"solid",loading:m,type:"submit",children:h?"Update Estimation":"Create Estimation"})})})]})]})})}})});we.displayName="EstimationForm";export{we as default};
