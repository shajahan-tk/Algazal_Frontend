import{r as x,v as we,ak as Ne,Y as Ce,j as e}from"./index-CfFwh--H.js";import{F as ke,a as c}from"./FormItem-CrM3E5oZ.js";import{B as P}from"./Button-DK8YG6Vd.js";import{S as Se}from"./StickyFooter-DkUgER91.js";import{F as Te,a as Fe,b,c as ne}from"./formik.esm-L7JVMBJt.js";import{c as se,g as U,e as oe,f as Ie,b as Q}from"./index.esm-CDTj4fG4.js";import{t as k,N as S}from"./toast-CZz_7xZu.js";import{A as T}from"./AdaptableCard-T1jSCi4m.js";import{I as g}from"./Input-CT3ndZ0a.js";import{$ as ce,a0 as me}from"./index-CEOENyZN.js";import{D as ue}from"./index-Tb9TnHR2.js";import{S as de}from"./Select-DXgitA5g.js";import{g as Ue,u as Qe,c as $e}from"./api-_ep5brxg.js";import"./context-ClB8cHxu.js";import"./index-CbqZmROt.js";import"./proxy-DVFC3BrG.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-ByyYtpKF.js";import"./StatusIcon-CVY_iJbr.js";import"./CloseButton-BXsrAn2U.js";import"./chainedFunction-BxZSneMW.js";import"./Card-DrR7Wowt.js";import"./Views-DDo_d-60.js";import"./toString-tgkm5ft3.js";import"./useControllableState-e9pFJmGN.js";import"./floating-ui.react-DGPs_AnH.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useUniqueId-C3QGMlyo.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";const pe=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"sq_m",label:"Square Meter (m²)"},{value:"sq_cm",label:"Square Centimeter (cm²)"},{value:"sq_mm",label:"Square Millimeter (mm²)"},{value:"sq_km",label:"Square Kilometer (km²)"},{value:"sq_in",label:"Square Inch (in²)"},{value:"sq_ft",label:"Square Foot (ft²)"},{value:"sq_yd",label:"Square Yard (yd²)"},{value:"acre",label:"Acre"},{value:"hectare",label:"Hectare (ha)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],be=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],ge=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],De=se().shape({validUntil:Ie().required("Valid Until date is required"),items:oe().of(se().shape({description:Q().required("Description is required"),uom:Q().required("Unit of measurement is required"),quantity:U().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:U().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:oe().of(Q().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:U().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),ze=x.forwardRef((he,ve)=>{const{onDiscard:fe}=he,je=we(),{projectId:w}=Ne(),{state:q}=Ce(),F=q==null?void 0:q.estimationId,h=q==null?void 0:q.quotationId,[ye,xe]=x.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:w,estimation:F}),[qe,Pe]=x.useState(!!h),[f,N]=x.useState([]),[j,I]=x.useState({});x.useEffect(()=>{(async()=>{var r,l,y;if(h)try{const i=(await Ue(w)).data,s={},n=[];(r=i.items)==null||r.forEach((t,m)=>{var p;(p=t.image)!=null&&p.url&&(s[m]=t.image.url),n[m]=null}),I(s),N(n),xe({_id:i._id,quotationNumber:i.quotationNumber,date:new Date(i.date),validUntil:new Date(i.validUntil),items:i.items.map(t=>({description:t.description,uom:t.uom,quantity:t.quantity,unitPrice:t.unitPrice,totalPrice:t.totalPrice,image:t.image})),termsAndConditions:i.termsAndConditions.length>0?i.termsAndConditions:[""],vatPercentage:i.vatPercentage,subtotal:i.subtotal,vatAmount:i.vatAmount,netAmount:i.netAmount,project:((l=i.project)==null?void 0:l._id)||w,estimation:((y=i.estimation)==null?void 0:y._id)||F})}catch(o){console.error("Error fetching quotation:",o),k.push(e.jsx(S,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data"}),{placement:"top-center"})}finally{Pe(!1)}})()},[h,w,F]);const Ae=async a=>{try{const r=f.filter(l=>l!==null);h?(await Qe(h,{...a,projectId:a.project,estimationId:a.estimation},r),k.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await $e({...a,projectId:a.project,estimationId:a.estimation},r),k.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),je(-1)}catch(r){console.error(`Error ${h?"updating":"creating"} quotation:`,r),k.push(e.jsxs(S,{title:"Error",type:"danger",duration:2500,children:["Failed to ",h?"update":"create"," quotation. Please try again."]}),{placement:"top-center"})}},$=(a,r)=>{const l=[...f];if(l[a]=r,N(l),r&&j[a]){const y={...j};delete y[a],I(y)}};return qe?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(Te,{innerRef:ve,initialValues:ye,validationSchema:De,onSubmit:Ae,enableReinitialize:!0,children:({values:a,touched:r,errors:l,isSubmitting:y,setFieldValue:o})=>(x.useEffect(()=>{a.items.forEach((t,m)=>{const p=parseFloat((t.quantity*t.unitPrice).toFixed(2));t.totalPrice!==p&&o(`items[${m}].totalPrice`,p)});const i=a.items.reduce((t,m)=>t+m.totalPrice,0);a.subtotal!==i&&o("subtotal",i);const s=parseFloat((i*(a.vatPercentage/100)).toFixed(2)),n=parseFloat((i+s).toFixed(2));a.vatAmount!==s&&o("vatAmount",s),a.netAmount!==n&&o("netAmount",n)},[a.items,a.vatPercentage]),e.jsx(Fe,{children:e.jsxs(ke,{children:[e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{label:"Quotation Number",children:e.jsx(b,{name:"quotationNumber",type:"text",component:g,readOnly:!0,value:a.quotationNumber})}),e.jsx(c,{label:"Date",children:e.jsx(b,{name:"date",children:({field:i})=>e.jsx(ue,{placeholder:"Select date",value:i.value,onChange:s=>{o("date",s)}})})}),e.jsx(c,{label:"Valid Until *",invalid:!!l.validUntil&&r.validUntil,errorMessage:l.validUntil,children:e.jsx(b,{name:"validUntil",children:({field:i})=>e.jsx(ue,{placeholder:"Select date",value:i.value,onChange:s=>{o("validUntil",s)}})})})]})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Items"}),e.jsx(ne,{name:"items",children:({push:i,remove:s})=>e.jsxs("div",{className:"space-y-4",children:[a.items.map((n,t)=>{var m,p,A,C,v,D,z,E,M,O,_,L,B,R,H,Y,G,K,V,J,W,X,Z,ee,te,ae,ie,le,re;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-b pb-4",children:[e.jsx(c,{label:`Item ${t+1}`,invalid:!!((p=(m=l.items)==null?void 0:m[t])!=null&&p.description)&&((C=(A=r.items)==null?void 0:A[t])==null?void 0:C.description),errorMessage:(D=(v=l.items)==null?void 0:v[t])==null?void 0:D.description,children:e.jsx(b,{as:g,name:`items[${t}].description`,placeholder:"Description",value:n.description,textArea:!0})}),e.jsx(c,{label:"UOM",invalid:!!((E=(z=l.items)==null?void 0:z[t])!=null&&E.uom)&&((O=(M=r.items)==null?void 0:M[t])==null?void 0:O.uom),errorMessage:(L=(_=l.items)==null?void 0:_[t])==null?void 0:L.uom,children:e.jsx(b,{name:`items[${t}].uom`,children:({field:u})=>e.jsx(de,{options:pe,value:pe.find(d=>d.value===u.value)||null,onChange:d=>{o(`items[${t}].uom`,(d==null?void 0:d.value)||"")},placeholder:"Select unit"})})}),e.jsx(c,{label:"Qty",invalid:!!((R=(B=l.items)==null?void 0:B[t])!=null&&R.quantity)&&((Y=(H=r.items)==null?void 0:H[t])==null?void 0:Y.quantity),errorMessage:(K=(G=l.items)==null?void 0:G[t])==null?void 0:K.quantity,children:e.jsx(b,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:g,min:0,step:"any",value:n.quantity||"",onChange:u=>{const d=parseFloat(u.target.value)||0;o(`items[${t}].quantity`,d)}})}),e.jsx(c,{label:"Unit Price",invalid:!!((J=(V=l.items)==null?void 0:V[t])!=null&&J.unitPrice)&&((X=(W=r.items)==null?void 0:W[t])==null?void 0:X.unitPrice),errorMessage:(ee=(Z=l.items)==null?void 0:Z[t])==null?void 0:ee.unitPrice,children:e.jsx(b,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:g,min:0,value:n.unitPrice||"",onChange:u=>{const d=parseFloat(u.target.value)||0;o(`items[${t}].unitPrice`,d)}})}),e.jsx(c,{label:"Total",children:e.jsx(g,{readOnly:!0,value:(n.quantity*n.unitPrice).toFixed(2),placeholder:"Total"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex justify-end",children:a.items.length>1&&e.jsx(P,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(ce,{}),onClick:()=>{s(t);const u=[...f];if(u.splice(t,1),N(u),j[t]){const d={...j};delete d[t],I(d)}}})}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"block w-full text-sm text-gray-500",children:e.jsxs("button",{className:"file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:u=>{u.target.files&&u.target.files[0]?$(t,u.target.files[0]):$(t,null)},className:"sr-only"}),"Choose Image"]})}),(j[t]||((te=n.image)==null?void 0:te.url))&&e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("img",{src:j[t]||((ae=n.image)==null?void 0:ae.url),alt:"Item",className:"h-10 w-10 object-cover rounded"}),e.jsx("span",{className:"text-xs text-gray-500 truncate max-w-[100px]",children:((ie=f[t])==null?void 0:ie.name)||"Uploaded image"})]}),f[t]&&!j[t]&&!((le=n.image)!=null&&le.url)&&e.jsx("span",{className:"text-xs text-gray-500 truncate max-w-[100px]",children:(re=f[t])==null?void 0:re.name})]})]})]},t)}),e.jsx(P,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(me,{}),onClick:()=>{i({description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}),N([...f,null])},children:"Add Item"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx(ne,{name:"termsAndConditions",children:({push:i,remove:s})=>e.jsxs("div",{className:"space-y-4",children:[a.termsAndConditions.map((n,t)=>{var m,p,A;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(c,{className:"flex-grow",invalid:!!((m=l.termsAndConditions)!=null&&m[t])&&((p=r.termsAndConditions)==null?void 0:p[t]),errorMessage:(A=l.termsAndConditions)==null?void 0:A[t],children:t<2?e.jsx(b,{name:`termsAndConditions[${t}]`,children:({field:C})=>e.jsx(de,{options:t===0?be:ge,value:(t===0?be:ge).find(v=>v.value===C.value)||null,onChange:v=>{o(`termsAndConditions[${t}]`,(v==null?void 0:v.value)||"")},placeholder:t===0?"Select work start term":"Select payment term"})}):e.jsx(b,{as:g,name:`termsAndConditions[${t}]`,placeholder:"Additional term or condition",value:n})}),e.jsx(P,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(ce,{}),onClick:()=>s(t)})]},t)}),e.jsx(P,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(me,{}),onClick:()=>i(""),children:"Add Term"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{label:"Subtotal",children:e.jsx(g,{readOnly:!0,value:a.subtotal.toFixed(2),placeholder:"Subtotal"})}),e.jsx(c,{label:"VAT Percentage",invalid:!!l.vatPercentage&&r.vatPercentage,errorMessage:l.vatPercentage,children:e.jsx(b,{as:g,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100,value:a.vatPercentage})}),e.jsx(c,{label:"VAT Amount",children:e.jsx(g,{readOnly:!0,value:a.vatAmount.toFixed(2),placeholder:"VAT amount"})}),e.jsx(c,{label:"Net Amount",children:e.jsx(g,{readOnly:!0,value:a.netAmount.toFixed(2),placeholder:"Net amount"})})]})]}),e.jsxs(Se,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(P,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:fe,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(P,{size:"sm",variant:"solid",loading:y,type:"submit",children:h?"Update Quotation":"Create Quotation"})})]})]})}))})});ze.displayName="QuotationForm";export{ze as default};
