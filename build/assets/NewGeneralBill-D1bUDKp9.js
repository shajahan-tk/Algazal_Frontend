import{r as p,j as e,v as L,ak as H}from"./index-CDUqAS1l.js";import{N as T,t as q}from"./toast-DGerJIJB.js";import{F as J,a as g}from"./FormItem-ByEmqHQ5.js";import{B as R}from"./Button-BPBskG9o.js";import{S as U}from"./StickyFooter-DBlfAIlK.js";import{F as Q,a as Y,b as f}from"./formik.esm-D7-nrDq7.js";import{A as K}from"./index-CwCYPHLJ.js";import{$ as V}from"./index-BerpkDBA.js";import{c as W,h as X,b as D,g as Z,f as ee}from"./index.esm-OMRqgHjV.js";import"./Alert-DL8X4Uab.js";import"./index-C1Nx0TEh.js";import"./Badge-hMcflglf.js";import{D as ae}from"./index-CRkWz9hY.js";import"./Card-Bb8Omztx.js";import"./Skeleton-DoyxclK2.js";import"./Dialog-C7AMlNhG.js";import"./Drawer-peSRAyXS.js";import"./index-DvFxqpjx.js";import"./useUniqueId-CQBDBfVD.js";import{I as $}from"./Input-DXBk0KXn.js";import"./index-Dk4smkVo.js";import"./index-cjDbE1Ce.js";import"./index-DQYmJabE.js";import"./index-ChKfPKLA.js";import"./ScrollBar-QR2Zwrhq.js";import{S as E}from"./Select-Bc7Wf5rB.js";import"./Upload-BJb1fzL_.js";import"./index-CocX0oO3.js";import"./Tag-Bq5dzNE2.js";import{A as O}from"./AdaptableCard-BXZ7gMWR.js";import"./Views-DmS3tele.js";import"./chart.config-CZuakYno.js";import"./DataTable-CVcq30BR.js";import"./SvgIcon-DCpuHJM3.js";import"./SegmentItemOption-CD7-Nqsw.js";import{k as te,l as re,o as ie,p as le,q as se}from"./api-DQdmRQDg.js";import{f as ne}from"./format-CBpsKyOP.js";import"./StatusIcon-twe9Eqr7.js";import"./CloseButton-BXRa_ZJ2.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-Dk6QltiT.js";import"./context-D-kJGxG9.js";import"./index-CJy_8sJq.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BmYztAKh.js";import"./floating-ui.react-CCBWD0pR.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-DyX12gyY.js";import"./_getPrototype-CIMlDKAv.js";import"./index-CjDcj2AV.js";import"./toString-DOI2nrr_.js";import"./index-DlSvysZf.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-CBdLSIrO.js";import"./index-B2bfEVVx.js";import"./useThemeClass-5GKJG2gx.js";const _=[{label:"ADCB",value:"adcb"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"}],oe=new Date,z=p.forwardRef((x,d)=>{const{type:k,initialData:m={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},onFormSubmit:I,onDiscard:v,onDelete:S}=x,[N,w]=p.useState([]),[M,F]=p.useState([]),[y,j]=p.useState([]),[i,B]=p.useState(!0);p.useEffect(()=>{m.attachments&&w(m.attachments)},[m]),p.useEffect(()=>{(async()=>{var s,r,u;try{const b=await te(),n=(s=b==null?void 0:b.data)==null?void 0:s.shops.map(t=>({label:t.shopName,value:t._id}));F(n||[]);const a=await re(),o=(u=(r=a==null?void 0:a.data)==null?void 0:r.categories)==null?void 0:u.map(t=>({label:t.name,value:t._id}));j(o||[])}catch(b){console.error("Failed to load data:",b)}finally{B(!1)}})()},[]);const C=W().shape({billType:D().required("Bill type is required"),billDate:ee().required("Bill date is required").typeError("Please select a valid date"),paymentMethod:D().required("Payment method is required"),amount:Z().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),category:D().required("Category is required"),shop:D().required("Shop is required"),invoiceNo:D(),remarks:D().max(500,"Remarks must be at most 500 characters"),attachments:X()}),c=l=>{if(l.target.files&&l.target.files.length>0){const s=Array.from(l.target.files);w(r=>[...r,...s])}},G=l=>{w(s=>s.filter((r,u)=>u!==l))};return e.jsx(Q,{innerRef:d,initialValues:{billType:m.billType||"general",billDate:m.billDate||"",paymentMethod:m.paymentMethod||"",amount:m.amount||"",category:m.category||"",shop:m.shop||"",invoiceNo:m.invoiceNo||"",remarks:m.remarks||"",attachments:m.attachments||[]},validationSchema:C,onSubmit:async(l,{setSubmitting:s,setErrors:r})=>{var u,b;try{const n=new FormData;n.append("billType",l.billType),n.append("billDate",l.billDate),n.append("paymentMethod",l.paymentMethod),n.append("amount",l.amount.toString()),n.append("category",l.category),n.append("shop",l.shop),n.append("invoiceNo",l.invoiceNo),n.append("remarks",l.remarks||""),N.forEach((a,o)=>{a instanceof File?n.append("attachments",a):typeof a=="string"&&k==="edit"&&n.append(`existingAttachments[${o}]`,a)}),await I(n,s)}catch(n){s(!1),(b=(u=n.response)==null?void 0:u.data)!=null&&b.errors&&r(n.response.data.errors),console.error("Form submission error:",n)}},enableReinitialize:!0,children:({values:l,touched:s,errors:r,isSubmitting:u,setFieldValue:b,handleBlur:n})=>e.jsx(Y,{children:e.jsxs(J,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Bill Type",invalid:!!r.billType&&s.billType,errorMessage:r.billType,children:e.jsx(f,{name:"billType",children:({field:a,form:o})=>{const t=[{label:"General",value:"general",disabled:!0}],A=t.find(h=>h.value===a.value)||t[0];return e.jsx(E,{options:t,value:A,isOptionDisabled:h=>h.disabled,onChange:h=>{o.setFieldValue(a.name,h==null?void 0:h.value)},onBlur:a.onBlur,name:a.name})}})}),e.jsx(g,{label:"Bill Date",invalid:!!r.billDate&&s.billDate,children:e.jsx(f,{name:"billDate",children:({field:a,form:o})=>e.jsx(ae,{placeholder:"Select billDate Date",value:a.value?new Date(a.value):null,maxDate:oe,onChange:t=>o.setFieldValue(a.name,t?ne(new Date(t.getFullYear(),t.getMonth(),t.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(g,{label:"Payment Method",invalid:!!r.paymentMethod&&s.paymentMethod,errorMessage:r.paymentMethod,children:e.jsx(f,{name:"paymentMethod",children:({field:a,form:o})=>e.jsx(E,{placeholder:"Select Payment Method",options:_,value:_.find(t=>t.value===l.paymentMethod),onChange:t=>{o.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur})})}),e.jsx(g,{label:"Amount",invalid:!!r.amount&&s.amount,errorMessage:r.amount,children:e.jsx(f,{name:"amount",children:({field:a,form:o})=>e.jsx($,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:t=>{o.setFieldValue(a.name,t.target.value)}})})})]})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Category",invalid:!!r.category&&s.category,errorMessage:r.category,children:e.jsx(f,{name:"category",children:({field:a,form:o})=>e.jsx(E,{placeholder:"Select Category",options:y,value:y.find(t=>t.value===l.category),onChange:t=>{o.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:i})})}),e.jsx(g,{label:"Shop",invalid:!!r.shop&&s.shop,errorMessage:r.shop,children:e.jsx(f,{name:"shop",children:({field:a,form:o})=>e.jsx(E,{placeholder:"Select Shop",options:M,value:M.find(t=>t.value===l.shop),onChange:t=>{o.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:i})})}),e.jsx(g,{label:"Invoice Number",invalid:!!r.invoiceNo&&s.invoiceNo,errorMessage:r.invoiceNo,children:e.jsx(f,{name:"invoiceNo",children:({field:a})=>e.jsx($,{type:"text",autoComplete:"off",placeholder:"Invoice Number",...a})})})]})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(g,{label:"Attachments",invalid:!!r.attachments&&s.attachments,errorMessage:r.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:c,onBlur:()=>n({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),N.length>0&&e.jsx("div",{className:"space-y-2",children:N.map((a,o)=>{const t=a instanceof File,A=t?a.name:a.fileName,h=t?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[h?e.jsx("a",{href:h,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:A}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:A}),e.jsx("button",{type:"button",onClick:()=>G(o),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(V,{})})]},o)})})]})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(g,{label:"Remarks",invalid:!!r.remarks&&s.remarks,errorMessage:r.remarks,children:e.jsx(f,{name:"remarks",children:({field:a})=>e.jsx($,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...a})})})]})]})}),e.jsxs(U,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:k==="edit"&&S&&e.jsx(R,{size:"sm",variant:"plain",color:"red",icon:e.jsx(V,{}),type:"button",onClick:()=>S(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(R,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>v==null?void 0:v(),children:"Discard"}),e.jsx(R,{size:"sm",variant:"solid",loading:u,icon:e.jsx(K,{}),type:"submit",children:"Save"})]})]})]})})})});z.displayName="GenBillForm";const P={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},pa=()=>{const x=L(),{id:d}=H(),[k,m]=p.useState(P),[I,v]=p.useState(!!d),[S,N]=p.useState(null);p.useEffect(()=>{if(!d){m(P),v(!1);return}(async()=>{var y,j;try{v(!0);const i=await ie(d);if(!(i!=null&&i.data))throw new Error("Invalid bill data received");m({billType:i.data.billType||"general",billDate:i.data.billDate||new Date().toISOString().split("T")[0],paymentMethod:i.data.paymentMethod||"",amount:i.data.amount||0,category:((y=i.data.category)==null?void 0:y._id)||i.data.category||"",shop:((j=i.data.shop)==null?void 0:j._id)||i.data.shop||"",invoiceNo:i.data.invoiceNo||"",remarks:i.data.remarks||"",attachments:i.data.attachments||[]}),N(null)}catch(i){console.error("Error fetching bill:",i),N(i.message||"Failed to load bill data"),q.push(e.jsx(T,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:i.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>x("/app/bill-view"),2500)}finally{v(!1)}})()},[d,x]);const w=async(F,y)=>{var j,i,B,C;try{y(!0);const c=d?await le(d,F):await se(F);if([200,201].includes(c.status))q.push(e.jsxs(T,{title:`Successfully ${d?"updated":"added"} bill`,type:"success",duration:2500,children:["Bill ",d?"updated":"added"," successfully"]}),{placement:"top-center"}),x("/app/bill-view");else throw new Error(((i=(j=c==null?void 0:c.response)==null?void 0:j.data)==null?void 0:i.message)||"Unexpected status code")}catch(c){console.error("Error during form submission:",c),q.push(e.jsx(T,{title:`Error ${d?"updating":"adding"} bill`,type:"danger",duration:2500,children:((C=(B=c==null?void 0:c.response)==null?void 0:B.data)==null?void 0:C.message)||c.message}),{placement:"top-center"})}finally{y(!1)}},M=()=>{JSON.stringify(k)!==JSON.stringify(P)?window.confirm("Are you sure you want to discard changes?")&&x("/app/bill-view"):x("/app/bill-view")};return I?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):S?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(T,{title:"Error loading bill",type:"danger",children:S})}):e.jsx(z,{type:d?"edit":"new",initialData:k,onFormSubmit:w,onDiscard:M})};export{pa as default};
