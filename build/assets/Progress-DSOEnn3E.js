import{r as d,ak as D,j as e,a4 as y}from"./index-CDUqAS1l.js";import{C as u}from"./Card-Bb8Omztx.js";import{I as k}from"./Input-DXBk0KXn.js";import{A as v}from"./AdaptableCard-BXZ7gMWR.js";import{C as w}from"./Views-DmS3tele.js";import{A as j}from"./index-C1Nx0TEh.js";import{B as C}from"./Button-BPBskG9o.js";import{P}from"./ProgressBar-DKuewUxS.js";import{aN as G,aO as L,aP as T,ai as $,aj as B,O,H as q}from"./index-BerpkDBA.js";import{a as F,b as W,c as z,d as X}from"./api-oQyvSCIn.js";import"./context-D-kJGxG9.js";import"./toString-DOI2nrr_.js";import"./floating-ui.react-CCBWD0pR.js";import"./floating-ui.dom-B_iSk-nO.js";import"./index-CJy_8sJq.js";import"./proxy-Dk6QltiT.js";const A=({children:t,...m})=>e.jsx(j,{...m,size:36,shape:"circle",className:"ring-2 ring-white dark:ring-gray-800",children:t}),Y=({status:t,time:m})=>{const l=(()=>{switch(t.toLowerCase()){case"approval":case"approved":return{bg:"bg-emerald-100 dark:bg-emerald-500/20",icon:e.jsx(q,{className:"text-emerald-600 dark:text-emerald-400"}),text:"Approved",textColor:"text-emerald-600 dark:text-emerald-400"};case"check":case"checked":return{bg:"bg-amber-100 dark:bg-amber-500/20",icon:e.jsx(O,{className:"text-amber-600 dark:text-amber-400"}),text:"Checked",textColor:"text-amber-600 dark:text-amber-400"};case"reject":case"rejected":return{bg:"bg-red-100 dark:bg-red-500/20",icon:e.jsx(B,{className:"text-red-600 dark:text-red-400"}),text:"Rejected",textColor:"text-red-600 dark:text-red-400"};case"progress_update":return{bg:"bg-indigo-100 dark:bg-indigo-500/20",icon:e.jsx(T,{className:"text-indigo-600 dark:text-indigo-400"}),text:"Progress Update",textColor:"text-indigo-600 dark:text-indigo-400"};default:return{bg:"bg-blue-100 dark:bg-blue-500/20",icon:e.jsx($,{className:"text-blue-600 dark:text-blue-400"}),text:"General",textColor:"text-blue-600 dark:text-blue-400"}}})();return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${l.bg} ${l.textColor}`,children:[e.jsx("span",{className:"mr-1",children:l.icon}),l.text]}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:m})]})},J=({comment:t})=>e.jsxs("div",{className:"flex mb-6 group",children:[e.jsxs("div",{className:"flex flex-col items-center mr-4",children:[e.jsx(A,{src:t.img}),e.jsx("div",{className:"w-px h-full bg-gray-200 dark:bg-gray-600 mt-2"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:t.name}),e.jsx(Y,{status:t.actionType||"general",time:t.time})]}),t.progress!==void 0&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-gray-500 dark:text-gray-400",children:"Progress"}),e.jsxs("span",{className:"text-xs font-semibold text-indigo-600 dark:text-indigo-400",children:[t.progress,"%"]})]}),e.jsx(P,{percent:t.progress,showInfo:!1,strokeColor:"#4f46e5",trailColor:"#e0e7ff",className:"h-2"})]}),e.jsx("div",{className:"p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:e.jsx("p",{className:"text-gray-800 dark:text-gray-200",children:t.comment})})]})]}),me=()=>{const[t,m]=d.useState(!0),[p,l]=d.useState(!1),[x,f]=d.useState(0),h=d.useRef(null),[b,N]=d.useState([]),{projectId:o}=D(),[S,U]=d.useState(!1),[_,I]=d.useState(!0),[c,H]=d.useState({workers:[],driver:null});d.useEffect(()=>{(async()=>{var i;try{const[r,a]=await Promise.all([F(o),W(o)]),n=r.data.data,g=a.data.data,R=["team_assigned","work_started","in_progress","work_completed","quality_check","client_handover"].includes(n.status);U(R&&((i=n.assignedWorkers)==null?void 0:i.length)>0&&n.assignedDriver),g&&H({workers:g.workers||[],driver:g.driver||null})}catch(r){console.error("Error checking team assignment:",r)}finally{I(!1)}})()},[o]),d.useEffect(()=>{(async()=>{try{m(!0);const i=await z(o);if(i.data){const r=i.data.map(a=>{var n,g;return{id:a._id,name:(n=a.user)!=null&&n.firstName?`${a.user.firstName} ${a.user.lastName}`:"Unknown User",img:((g=a.user)==null?void 0:g.profileImage)||"/img/avatars/thumb-1.jpg",time:new Date(a.createdAt).toLocaleString(),comment:a.content,actionType:a.actionType,progress:a.progress}});N(r),r.length>0&&r[0].progress!==void 0&&f(r[0].progress)}}catch(i){console.error("Failed to fetch progress updates:",i)}finally{m(!1)}})()},[o]);const E=async()=>{var i;const s=(i=h.current)==null?void 0:i.value;if(s!=null&&s.trim())try{l(!0);const r=await X({projectId:o,progress:x,comment:s});if(r.data){const a={id:r.data._id,name:"You",img:"/img/avatars/thumb-1.jpg",time:"just now",comment:s,actionType:"progress_update",progress:x};N(n=>[a,...n]),h.current&&(h.current.value="")}}catch(r){console.error("Failed to submit progress update:",r)}finally{l(!1)}};return _?e.jsx(y,{}):S?e.jsx(w,{className:"h-full",children:e.jsx(y,{loading:t,children:e.jsxs(v,{bodyClass:"p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-900 dark:text-white mb-1",children:"Project Progress"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Track and update the current status of the project"})]}),e.jsx(u,{className:"mb-8",bordered:!0,children:e.jsxs("div",{className:"p-5",children:[e.jsxs("h5",{className:"text-md font-semibold mb-4 flex items-center gap-2 dark:text-gray-200",children:[e.jsx(G,{className:"text-indigo-600 dark:text-indigo-400"}),"Assigned Team"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("h6",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-3",children:["Workers (",c.workers.length,")"]}),e.jsxs("div",{className:"space-y-3",children:[c.workers.map(s=>e.jsxs("div",{className:"flex items-center p-2 border rounded dark:border-gray-600",children:[e.jsx(j,{src:s.profileImage}),e.jsxs("span",{className:"ml-3 dark:text-gray-200",children:[s.firstName," ",s.lastName]})]},s._id)),c.workers.length===0&&e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm py-2",children:"No workers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("h6",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2",children:[e.jsx(L,{className:"text-indigo-600 dark:text-indigo-400"}),"Driver"]}),c.driver?e.jsxs("div",{className:"flex items-center p-2 border rounded dark:border-gray-600",children:[e.jsx(j,{src:c.driver.profileImage}),e.jsxs("span",{className:"ml-3 dark:text-gray-200",children:[c.driver.firstName," ",c.driver.lastName]})]}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm py-2",children:"No driver assigned"})]})]})]})}),e.jsx(u,{className:"mb-8",bordered:!0,children:e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h5",{className:"text-md font-semibold dark:text-gray-200",children:"Current Progress"}),e.jsxs("span",{className:"text-lg font-bold text-indigo-600 dark:text-indigo-400",children:[x,"%"]})]}),e.jsx(P,{percent:x,showInfo:!1,className:"mb-4",strokeColor:"#4f46e5",trailColor:"#e0e7ff",className:"h-3"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(k,{type:"range",min:"0",max:"100",step:"5",value:x,onChange:s=>f(Number(s.target.value)),className:"flex-1"}),e.jsxs("span",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 w-12 text-center",children:[x,"%"]})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h5",{className:"text-md font-semibold mb-4 dark:text-gray-200",children:"Progress History"}),b.length>0?e.jsx("div",{className:"space-y-6",children:b.map(s=>e.jsx(J,{comment:s},s.id))}):e.jsxs(u,{className:"text-center py-8 border-dashed dark:border-gray-600",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No progress updates yet"}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-1",children:"Be the first to update the progress"})]})]}),e.jsx(u,{bordered:!0,children:e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx(A,{src:"/img/avatars/thumb-1.jpg"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h6",{className:"text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Add Progress Update"}),e.jsx(k,{ref:h,textArea:!0,placeholder:"Describe what's been completed, any challenges, or next steps...",disabled:p,rows:3}),e.jsxs("div",{className:"flex justify-between items-center mt-3",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Progress will be saved with your comment"}),e.jsx(C,{variant:"solid",onClick:E,loading:p,disabled:p,icon:e.jsx(T,{}),children:"Post Update"})]})]})]})})})]})})}):e.jsx(w,{className:"h-full",children:e.jsx(v,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h3",{className:"text-lg font-medium mb-2 dark:text-gray-200",children:"Team Not Assigned"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Please assign workers and a driver before updating progress"}),e.jsx(C,{variant:"solid",onClick:()=>window.location.href=`/app/teams-assign/${o}`,children:"Assign Team"})]})})})};export{me as default};
