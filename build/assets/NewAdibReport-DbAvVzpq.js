import{r as p,j as e,v as U,ak as H}from"./index-CDUqAS1l.js";import{N as E,t as q}from"./toast-DGerJIJB.js";import{F as G,a as S}from"./FormItem-ByEmqHQ5.js";import{B as V}from"./Button-BPBskG9o.js";import{S as K}from"./StickyFooter-DBlfAIlK.js";import{F as Q,a as W,b as w}from"./formik.esm-D7-nrDq7.js";import{A as X}from"./index-CwCYPHLJ.js";import{$ as z}from"./index-BerpkDBA.js";import{c as Y,h as Z,b as $,g as ee,f as te}from"./index.esm-OMRqgHjV.js";import"./Alert-DL8X4Uab.js";import"./index-C1Nx0TEh.js";import"./Badge-hMcflglf.js";import{D as ae}from"./index-CRkWz9hY.js";import"./Card-Bb8Omztx.js";import"./Skeleton-DoyxclK2.js";import"./Dialog-C7AMlNhG.js";import"./Drawer-peSRAyXS.js";import"./index-DvFxqpjx.js";import"./useUniqueId-CQBDBfVD.js";import{I as P}from"./Input-DXBk0KXn.js";import"./index-Dk4smkVo.js";import"./index-cjDbE1Ce.js";import"./index-DQYmJabE.js";import"./index-ChKfPKLA.js";import"./ScrollBar-QR2Zwrhq.js";import{S as L}from"./Select-Bc7Wf5rB.js";import"./Upload-BJb1fzL_.js";import"./index-CocX0oO3.js";import"./Tag-Bq5dzNE2.js";import{A as R}from"./AdaptableCard-BXZ7gMWR.js";import"./Views-DmS3tele.js";import"./chart.config-CZuakYno.js";import"./DataTable-CVcq30BR.js";import"./SvgIcon-DCpuHJM3.js";import"./SegmentItemOption-CD7-Nqsw.js";import{k as re,l as se,B as ie,C as oe,D as ne}from"./api-DQdmRQDg.js";import"./StatusIcon-twe9Eqr7.js";import"./CloseButton-BXRa_ZJ2.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-Dk6QltiT.js";import"./context-D-kJGxG9.js";import"./index-CJy_8sJq.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BmYztAKh.js";import"./floating-ui.react-CCBWD0pR.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-DyX12gyY.js";import"./_getPrototype-CIMlDKAv.js";import"./index-CjDcj2AV.js";import"./toString-DOI2nrr_.js";import"./index-DlSvysZf.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-CBdLSIrO.js";import"./index-B2bfEVVx.js";import"./useThemeClass-5GKJG2gx.js";const le=new Date,J=p.forwardRef((b,c)=>{const{type:A,initialData:i={reportDate:new Date,amount:0,category:"",shop:"",remarks:"",attachments:[]},onFormSubmit:B,onDiscard:y,onDelete:D}=b,[N,O]=p.useState([]),[F,m]=p.useState([]),[f,j]=p.useState(!0),[a,k]=p.useState(i.attachments||[]);p.useEffect(()=>{(async()=>{var o,s,u;try{const h=await re(),g=(o=h==null?void 0:h.data)==null?void 0:o.shops.map(r=>({label:r.shopName,value:r._id}));O(g||[]);const t=await se(),l=(u=(s=t==null?void 0:t.data)==null?void 0:s.categories)==null?void 0:u.map(r=>({label:r.name,value:r._id}));m(l||[])}catch(h){console.error("Failed to load data:",h)}finally{j(!1)}})()},[]);const C=d=>{if(d.target.files&&d.target.files.length>0){const o=Array.from(d.target.files);k(s=>[...s,...o])}},n=d=>{k(o=>o.filter((s,u)=>u!==d))},v=Y().shape({reportDate:te().required("Bill date is required").typeError("Please select a valid date"),amount:ee().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),category:$().required("Category is required"),shop:$().required("Shop is required"),remarks:$().max(500,"Remarks must be at most 500 characters"),attachments:Z()}),x=()=>i.category&&F.find(d=>d.value===i.category)||null,_=()=>i.shop&&N.find(d=>d.value===i.shop)||null;return e.jsx(Q,{innerRef:c,initialValues:{reportDate:i.reportDate instanceof Date?i.reportDate:new Date(i.reportDate),amount:i.amount||"",category:i.category||"",shop:i.shop||"",remarks:i.remarks||"",attachments:i.attachments||[],selectedCategory:x(),selectedShop:_()},validationSchema:v,onSubmit:async(d,{setSubmitting:o,setErrors:s})=>{var u,h;try{const g={...d,attachments:a,selectedCategory:void 0,selectedShop:void 0};await B(g,o)}catch(g){o(!1),(h=(u=g.response)==null?void 0:u.data)!=null&&h.errors&&s(g.response.data.errors),console.error("Form submission error:",g)}},enableReinitialize:!0,children:({values:d,touched:o,errors:s,isSubmitting:u,setFieldValue:h,handleBlur:g})=>e.jsx(W,{children:e.jsxs(G,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"ADIB Report Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{label:"Bill Date",invalid:!!s.reportDate&&o.reportDate,children:e.jsx(w,{name:"reportDate",children:({field:t,form:l})=>e.jsx(ae,{placeholder:"Select Bill Date",value:t.value?new Date(t.value):null,maxDate:le,onChange:r=>l.setFieldValue(t.name,r||null)})})}),e.jsx(S,{label:"Amount",invalid:!!s.amount&&o.amount,errorMessage:s.amount,children:e.jsx(w,{name:"amount",children:({field:t,form:l})=>e.jsx(P,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:r=>{l.setFieldValue(t.name,r.target.value)}})})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{label:"Category",invalid:!!s.category&&o.category,errorMessage:s.category,children:e.jsx(w,{name:"selectedCategory",children:({field:t,form:l})=>e.jsx(L,{placeholder:"Select Category",options:F,value:t.value,onChange:r=>{l.setFieldValue("selectedCategory",r),l.setFieldValue("category",(r==null?void 0:r.value)||"")},onBlur:t.onBlur,loading:f})})}),e.jsx(S,{label:"Shop Name",invalid:!!s.shop&&o.shop,errorMessage:s.shop,children:e.jsx(w,{name:"selectedShop",children:({field:t,form:l})=>e.jsx(L,{placeholder:"Select Shop",options:N,value:t.value,onChange:r=>{l.setFieldValue("selectedShop",r),l.setFieldValue("shop",(r==null?void 0:r.value)||"")},onBlur:t.onBlur,loading:f})})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(S,{label:"Remarks",invalid:!!s.remarks&&o.remarks,errorMessage:s.remarks,children:e.jsx(w,{name:"remarks",children:({field:t})=>e.jsx(P,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...t})})})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(S,{label:"Attachments",invalid:!!s.attachments&&o.attachments,errorMessage:s.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:C,onBlur:()=>g({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),a.length>0&&e.jsx("div",{className:"space-y-2",children:a.map((t,l)=>{const r=t instanceof File,M=r?t.name:t.fileName,T=r?void 0:t.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[T?e.jsx("a",{href:T,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:M}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:M}),e.jsx("button",{type:"button",onClick:()=>n(l),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(z,{})})]},l)})})]})]})]})}),e.jsxs(K,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:A==="edit"&&D&&e.jsx(V,{size:"sm",variant:"plain",color:"red",icon:e.jsx(z,{}),type:"button",onClick:()=>D(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(V,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>y==null?void 0:y(),children:"Discard"}),e.jsx(V,{size:"sm",variant:"solid",loading:u,icon:e.jsx(X,{}),type:"submit",children:"Save"})]})]})]})})})});J.displayName="AdibReportForm";const I={reportDate:new Date().toISOString().split("T")[0],amount:"",category:"",shop:"",remarks:"",attachments:[]},mt=()=>{const b=U(),{id:c}=H(),[A,i]=p.useState(I),[B,y]=p.useState(!!c),[D,N]=p.useState(null);p.useEffect(()=>{if(!c){i(I),y(!1);return}(async()=>{var f,j;try{y(!0);const a=await ie(c);if(!(a!=null&&a.data))throw new Error("Invalid report data received");i({reportDate:a.data.reportDate||I.reportDate,amount:a.data.amount||"",category:((f=a.data.category)==null?void 0:f._id)||a.data.category||"",shop:((j=a.data.shop)==null?void 0:j._id)||a.data.shop||"",remarks:a.data.remarks||"",attachments:a.data.attachments||[]}),N(null)}catch(a){console.error("Error fetching report:",a),N(a.message||"Failed to load report data"),q.push(e.jsx(E,{title:"Failed to fetch Aadib report data",type:"danger",duration:2500,children:a.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>b("/app/aadib-report-view"),2500)}finally{y(!1)}})()},[c,b]);const O=async(m,f)=>{var j,a,k,C;try{f(!0);const n=new FormData;n.append("reportType","adib"),Object.keys(m).forEach(x=>{x!=="attachments"&&n.append(x,m[x])}),m.attachments&&m.attachments.length>0&&m.attachments.forEach((x,_)=>{x instanceof File&&n.append("attachments",x)}),m.reportDate instanceof Date&&n.set("reportDate",m.reportDate.toISOString());const v=c?await oe(c,n):await ne(n);if([200,201].includes(v.status))q.push(e.jsxs(E,{title:`Successfully ${c?"updated":"added"} Aadib report`,type:"success",duration:2500,children:["Aadib report ",c?"updated":"added"," successfully"]}),{placement:"top-center"}),b("/app/adib-report-view");else throw new Error(((a=(j=v==null?void 0:v.response)==null?void 0:j.data)==null?void 0:a.message)||"Unexpected status code")}catch(n){console.error("Error during form submission:",n),q.push(e.jsx(E,{title:`Error ${c?"updating":"adding"} Aadib report`,type:"danger",duration:2500,children:((C=(k=n==null?void 0:n.response)==null?void 0:k.data)==null?void 0:C.message)||n.message}),{placement:"top-center"})}finally{f(!1)}},F=()=>{JSON.stringify(A)!==JSON.stringify(I)?window.confirm("Are you sure you want to discard changes?")&&b("/app/aadib-report-view"):b("/app/aadib-report-view")};return B?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):D?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(E,{title:"Error loading Aadib report",type:"danger",children:D})}):e.jsx(J,{type:c?"edit":"new",initialData:A,onFormSubmit:O,onDiscard:F})};export{mt as default};
