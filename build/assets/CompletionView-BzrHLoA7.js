import{r as d,j as e,an as v,u as te,ak as ae,v as re,a4 as G,b as E}from"./index-B-3YdMmO.js";import{C as oe}from"./Views-o_SZwizf.js";import{C as ce}from"./Card-Dg6B2cp2.js";import{B as p}from"./Button-CfVbO-qU.js";import{L as ne}from"./Logo-C6RBJ_pF.js";import{aQ as le,$ as ie,aG as de,a6 as pe,a2 as I,aR as W}from"./index-C7R1WpOH.js";import{u as me}from"./useThemeClass-BEUnEzZK.js";import"./Alert-QJLDMk5I.js";import"./index-Bo39LFtR.js";import"./Badge-B2PjptLi.js";import"./index-DCFjNNBJ.js";import"./Skeleton-C9LsrBBE.js";import{D as he}from"./Dialog-DSC5KQx1.js";import"./Drawer-CIBw5hlm.js";import"./index-DVAakj00.js";import{F as xe,a as _}from"./FormItem-B_dHMuui.js";import"./useUniqueId-bhrNi0MA.js";import{I as S}from"./Input-m_H_R88b.js";import"./index-B_Yvn3dy.js";import"./index-Z4dDP0Pn.js";import{t as h,N as x}from"./toast-xjy4rp4Y.js";import"./index-BdrlLZgj.js";import"./index-5z68-iaN.js";import"./ScrollBar-C_iOIJGq.js";import"./Select-DPSULLBa.js";import{U as ue}from"./Upload-CuAXzTtV.js";import"./index-CqQ94ycg.js";import"./Tag-D_vNYl-M.js";import"./context-_TTgW2bZ.js";import"./StatusIcon-IxYTyNOx.js";import"./CloseButton-8arYtbYT.js";import"./proxy-nPFZIZ0Z.js";import"./floating-ui.react-l_cC_yYr.js";import"./floating-ui.dom-B_iSk-nO.js";import"./index-Dhg3PmVb.js";import"./useControllableState-HmMJSzbR.js";import"./_getPrototype-BJeMep-l.js";import"./index-BL9xzUQn.js";import"./toString-B2j7ZGf1.js";import"./chainedFunction-BxZSneMW.js";import"./index-CYY49BFP.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./hoist-non-react-statics.cjs-VlwWE1Gk.js";import"./index-BLqgq88H.js";const je=({isOpen:r,onClose:a,onUpload:l,projectId:i})=>{const[t,f]=d.useState([]),[N,g]=d.useState([]),[b,y]=d.useState([]),P=d.useRef(null),C=c=>{if(c&&c.length>0){const o=Array.from(c).map(n=>({id:`${n.name}-${Date.now()}`,name:n.name,type:n.type,size:n.size,file:n}));f(n=>[...n,...o]),g(n=>[...n,...o.map(()=>"")]),y(n=>[...n,...o.map(()=>"")])}return!1},M=(c,o)=>{g(n=>{const m=[...n];return m[c]=o,m})},U=(c,o)=>{y(n=>{const m=[...n];return m[c]=o,m})},F=c=>{f(o=>o.filter((n,m)=>m!==c)),g(o=>o.filter((n,m)=>m!==c)),y(o=>o.filter((n,m)=>m!==c))},D=()=>{const c=t.map(o=>o.file);l(c,N,b),f([]),g([]),y([]),a()};return e.jsxs(he,{isOpen:r,onClose:a,onRequestClose:a,width:800,children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("h4",{children:"Upload Work Completion Images"})}),e.jsxs("div",{className:"mb-6",children:[e.jsx(ue,{ref:P,beforeUpload:C,showList:!1,multiple:!0,accept:"image/*",children:e.jsx(p,{variant:"solid",icon:e.jsx(le,{}),type:"button",children:"Select Images"})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Upload images of completed work (JPEG, PNG)"})]}),t.length>0&&e.jsx("div",{className:"max-h-96 overflow-y-auto",children:t.map((c,o)=>e.jsx("div",{className:"mb-4 p-4 border rounded",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-24 h-24 bg-gray-100 rounded overflow-hidden",children:c.type.startsWith("image/")&&e.jsx("img",{src:URL.createObjectURL(c.file),alt:c.name,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1",children:e.jsxs(xe,{children:[e.jsx(_,{label:"Title",className:"mb-3",children:e.jsx(S,{value:N[o]||"",onChange:n=>M(o,n.target.value),placeholder:"Enter image title",required:!0})}),e.jsx(_,{label:"Description (Optional)",children:e.jsx(S,{value:b[o]||"",onChange:n=>U(o,n.target.value),placeholder:"Enter description"})})]})}),e.jsx(p,{shape:"circle",variant:"plain",icon:e.jsx(ie,{}),onClick:()=>F(o),className:"text-red-500 hover:text-red-600"})]})},c.id))}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(p,{variant:"plain",onClick:a,children:"Cancel"}),e.jsx(p,{variant:"solid",onClick:D,disabled:t.length===0||N.some(c=>!(c!=null&&c.trim())),children:"Upload Images"})]})]})},q=async r=>{try{const a=await v.get(`/work-completion/project/${r}/work-comp`);return console.log(a.data),a.data}catch(a){throw console.error("Error fetching completion data:",a),a}},fe=async r=>{try{const a=new FormData;return r.images.forEach(i=>{a.append("images",i)}),r.titles.forEach(i=>{a.append("titles",i)}),r.descriptions&&r.descriptions.forEach(i=>{a.append("descriptions",i)}),(await v.post(`/work-completion/project/${r.projectId}/images`,a,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(a){throw console.error("Error uploading completion images:",a),a}},ge=async r=>{try{return(await v.post("/work-completion",{projectId:r})).data}catch(a){throw console.error("Error creating work completion:",a),a}},ye=async r=>{var a;try{const l=await v.get(`/work-completion/project/${r}/certificate`,{responseType:"blob"}),i=window.URL.createObjectURL(new Blob([l.data])),t=document.createElement("a");return t.href=i,t.setAttribute("download",`completion-certificate-${r}.pdf`),document.body.appendChild(t),t.click(),(a=t.parentNode)==null||a.removeChild(t),window.URL.revokeObjectURL(i),l.data}catch(l){throw console.error("Error downloading completion certificate:",l),l}},ve=async(r,a)=>{try{return(await v.put(`/work-completion/project/${r}/completion-date`,{date:a})).data}catch(l){throw console.error("Error updating completion date:",l),l}},Ne=async(r,a)=>{try{return(await v.put(`/work-completion/project/${r}/handover-date`,{date:a})).data}catch(l){throw console.error("Error updating handover date:",l),l}},Ce=async(r,a)=>{try{return(await v.put(`/work-completion/project/${r}/acceptance-date`,{date:a})).data}catch(l){throw console.error("Error updating acceptance date:",l),l}},we=()=>{var R,H;const{textTheme:r}=me(),a=te(s=>s.theme.mode),[l,i]=d.useState(!0),[t,f]=d.useState(null),[N,g]=d.useState(null),[b,y]=d.useState(!1),[P,C]=d.useState(!1),[M,U]=d.useState(!1),[F,D]=d.useState(!1),[c,o]=d.useState(!1),[n,m]=d.useState(!1),[Y,T]=d.useState(""),[$,L]=d.useState(""),[O,A]=d.useState(""),{projectId:u}=ae(),J=re(),Q=async()=>{try{i(!0);const s=await q(u);f(s.data)}catch(s){console.error("Error fetching completion data:",s),g("Failed to load completion data")}finally{i(!1)}};d.useEffect(()=>{u||J("/app/dashboard"),Q()},[u]);const V=async(s,j,w)=>{var B,z;try{i(!0),await fe({projectId:u,images:s,titles:j,descriptions:w});const k=await q(u);f(k.data),h.push(e.jsx(x,{title:"Success",type:"success",children:"Images uploaded successfully"}))}catch(k){console.error("Error uploading images:",k),h.push(e.jsxs(x,{title:"Error",type:"danger",children:["Failed to upload images: ",((z=(B=k.response)==null?void 0:B.data)==null?void 0:z.message)||k.message]}))}finally{i(!1)}},K=async()=>{try{U(!0);const s=await ge(u);f(s.data),h.push(e.jsx(x,{title:"Success",type:"success",children:"Work completion created successfully"}))}catch(s){console.error("Error creating work completion:",s),h.push(e.jsx(x,{title:"Error",type:"danger",children:"Failed to create work completion"}))}finally{U(!1)}},X=async()=>{var s;y(!0),g("");try{await ye(u),h.push(e.jsx(x,{title:"Success",type:"success",children:"PDF downloaded successfully"}))}catch(j){console.error("Error downloading PDF:",j),g("Failed to download PDF");let w="Failed to download PDF";j.response&&(j.response.status===404?w="Project data not found for PDF generation":j.response.status===400?w="Invalid project data for PDF generation":(s=j.response.data)!=null&&s.message&&(w=j.response.data.message)),h.push(e.jsx(x,{title:"Error",type:"danger",children:w}))}finally{y(!1)}},Z=async()=>{try{i(!0);const s=await ve(u,Y);f(s.data),h.push(e.jsx(x,{title:"Success",type:"success",children:"Completion date updated successfully"})),D(!1)}catch(s){console.error("Error updating completion date:",s),h.push(e.jsx(x,{title:"Error",type:"danger",children:"Failed to update completion date"}))}finally{i(!1)}},ee=async()=>{try{i(!0);const s=await Ne(u,$);f(s.data),h.push(e.jsx(x,{title:"Success",type:"success",children:"Handover date updated successfully"})),o(!1)}catch(s){console.error("Error updating handover date:",s),h.push(e.jsx(x,{title:"Error",type:"danger",children:"Failed to update handover date"}))}finally{i(!1)}},se=async()=>{try{i(!0);const s=await Ce(u,O);f(s.data),h.push(e.jsx(x,{title:"Success",type:"success",children:"Acceptance date updated successfully"})),m(!1)}catch(s){console.error("Error updating acceptance date:",s),h.push(e.jsx(x,{title:"Error",type:"danger",children:"Failed to update acceptance date"}))}finally{i(!1)}};return N?e.jsxs("div",{className:"p-4 text-center text-red-500",children:[N,e.jsx(p,{className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]}):t?e.jsxs(G,{loading:l,children:[e.jsx(je,{isOpen:P,onClose:()=>C(!1),onUpload:V,projectId:u}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between gap-4 mb-10",children:[e.jsxs("div",{children:[e.jsx(ne,{className:"mb-3",mode:a}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"COMPLETION CERTIFICATE"})]}),e.jsxs("div",{className:"my-4",children:[e.jsxs("div",{className:"mb-2",children:[e.jsxs("h4",{children:["Reference: ",t.referenceNumber]}),e.jsx("div",{className:"flex flex-col space-y-1",children:e.jsxs("span",{children:["Prepared On: ",E(t.createdAt).format("dddd, DD MMMM, YYYY")]})})]}),e.jsxs("div",{className:"mt-4 flex",children:[e.jsx(de,{className:`text-xl ${r}`}),e.jsxs("div",{className:"ltr:ml-3 rtl:mr-3",children:["Prepared By: ",(R=t.preparedBy)==null?void 0:R.firstName," ",(H=t.preparedBy)==null?void 0:H.lastName]})]}),e.jsxs("div",{className:"mt-4 flex",children:[e.jsx(pe,{className:`text-xl ${r}`}),e.jsx("div",{className:"ltr:ml-3 rtl:mr-3",children:e.jsxs("h6",{children:["Project: ",t.project.projectName]})})]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"FM Contractor:"})," ",t.fmContractor]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Sub Contractor:"})," ",t.subContractor]})]}),e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Project Description:"})," ",t.projectDescription]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Location:"})," ",t.location]})]})]}),e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded",children:e.jsx("p",{className:"text-center italic",children:"This is to certify that the work described above on project description has been cleared out and completed."})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Completion Date:"})," "]}),F?e.jsxs("div",{className:"flex items-center ml-2",children:[e.jsx(S,{type:"date",value:Y,onChange:s=>T(s.target.value),className:"ml-2 w-40"}),e.jsx(p,{size:"xs",className:"ml-2",onClick:Z,children:"Save"}),e.jsx(p,{size:"xs",className:"ml-2",variant:"plain",onClick:()=>D(!1),children:"Cancel"})]}):e.jsxs("div",{className:"flex items-center ml-2",children:[E(t.completionDate).format("DD MMMM, YYYY"),e.jsx(I,{className:`ml-2 cursor-pointer ${r}`,onClick:()=>{T(t.completionDate.split("T")[0]),D(!0)}})]})]}),e.jsx("div",{children:e.jsxs("p",{children:[e.jsx("strong",{children:"LPO Number:"})," ",t.lpoNumber]})}),e.jsx("div",{children:e.jsxs("p",{children:[e.jsx("strong",{children:"LPO Date:"})," ",E(t.lpoDate).format("DD MMMM, YYYY")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8",children:[e.jsxs("div",{className:"border rounded p-4",children:[e.jsx("h5",{className:"font-bold mb-4 text-center",children:"Hand Over By"}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Company:"}),e.jsx("td",{className:"py-2",children:t.handover.company})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Name:"}),e.jsx("td",{className:"py-2",children:t.handover.name})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Date:"}),e.jsx("td",{className:"py-2",children:c?e.jsxs("div",{className:"flex items-center",children:[e.jsx(S,{type:"date",value:$,onChange:s=>L(s.target.value),className:"w-40"}),e.jsx(p,{size:"xs",className:"ml-2",onClick:ee,children:"Save"}),e.jsx(p,{size:"xs",className:"ml-2",variant:"plain",onClick:()=>o(!1),children:"Cancel"})]}):e.jsxs("div",{className:"flex items-center",children:[E(t.handover.date).format("DD MMMM, YYYY"),e.jsx(I,{className:`ml-2 cursor-pointer ${r}`,onClick:()=>{L(t.handover.date.split("T")[0]),o(!0)}})]})})]})]})})]}),e.jsxs("div",{className:"border rounded p-4",children:[e.jsx("h5",{className:"font-bold mb-4 text-center",children:"Accepted By"}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Company:"}),e.jsx("td",{className:"py-2",children:t.acceptance.company})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Name:"}),e.jsx("td",{className:"py-2",children:t.acceptance.name})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Date:"}),e.jsx("td",{className:"py-2",children:n?e.jsxs("div",{className:"flex items-center",children:[e.jsx(S,{type:"date",value:O,onChange:s=>A(s.target.value),className:"w-40"}),e.jsx(p,{size:"xs",className:"ml-2",onClick:se,children:"Save"}),e.jsx(p,{size:"xs",className:"ml-2",variant:"plain",onClick:()=>m(!1),children:"Cancel"})]}):e.jsxs("div",{className:"flex items-center",children:[E(t.acceptance.date).format("DD MMMM, YYYY"),e.jsx(I,{className:`ml-2 cursor-pointer ${r}`,onClick:()=>{A(t.acceptance.date.split("T")[0]),m(!0)}})]})})]})]})})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"font-bold",children:"Site Pictures:"}),e.jsx(p,{variant:"solid",icon:e.jsx(W,{}),onClick:()=>C(!0),children:"Add Images"})]}),t.sitePictures.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:t.sitePictures.map((s,j)=>e.jsxs("div",{className:"border rounded overflow-hidden",children:[e.jsx("img",{src:s.url,alt:s.caption||`Site Image ${j+1}`,className:"w-full h-48 object-cover"}),s.caption&&e.jsx("div",{className:"p-2 bg-gray-50 dark:bg-gray-700 text-center",children:e.jsx("p",{className:"text-sm",children:s.caption})})]},`image-${j}`))}):e.jsxs("div",{className:"text-center py-8 border rounded bg-gray-50 dark:bg-gray-700",children:[e.jsx("p",{children:"No site pictures uploaded yet"}),e.jsx(p,{className:"mt-4",variant:"solid",icon:e.jsx(W,{}),onClick:()=>C(!0),children:"Upload Images"})]})]}),e.jsxs("div",{className:"print:hidden mt-6 flex items-center justify-end gap-2",children:[e.jsx(p,{variant:"solid",onClick:()=>C(!0),children:"Add More Images"}),e.jsx(p,{variant:"solid",loading:b,onClick:X,children:b?"Generating PDF...":"Download Completion Certificate"})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(G,{loading:M}),e.jsx("p",{className:"mt-4 mb-6",children:"No work completion record found for this project"}),e.jsx(p,{variant:"solid",loading:M,onClick:K,children:"Create Work Completion"})]})},us=()=>e.jsx(oe,{className:"h-full",children:e.jsx(ce,{className:"h-full",bodyClass:"h-full",children:e.jsx(we,{})})});export{us as default};
