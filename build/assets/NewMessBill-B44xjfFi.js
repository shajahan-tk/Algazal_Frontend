import{r as h,j as e,v as _,ak as z}from"./index-DrziBPhZ.js";import{N as C,t as k}from"./toast-ClnWKBBo.js";import{F as L,a as g}from"./FormItem-Cku4jOg1.js";import{B as T}from"./Button-DG2-jqZG.js";import{S as J}from"./StickyFooter-RWxGWKXo.js";import{F as H,a as U,b as j}from"./formik.esm-CPLrydYm.js";import{A as Q}from"./index-CBDs7g4_.js";import{$ as P}from"./index-Ds8t50Me.js";import{c as Y,g as G,b as B}from"./index.esm-BB-UMuCJ.js";import"./Alert-BLGo7HyM.js";import"./index-yw21U4bP.js";import"./Badge-C2KmHilm.js";import{D as K}from"./index-BmalSfvl.js";import"./Card-nlnRLrlQ.js";import"./Skeleton-C2woZuKJ.js";import"./Dialog-D7FxUuyk.js";import"./Drawer-IABuvwPK.js";import"./index-8tDMqpHX.js";import"./useUniqueId-B25XPIVz.js";import{I as q}from"./Input-B4wHBRkW.js";import"./index-DKNJHN__.js";import"./index-ChB5CpHQ.js";import"./index-DN1w59Ps.js";import"./index-Cv7sYzj3.js";import"./ScrollBar-CAweRmRR.js";import{S as E}from"./Select-nm3Sb7o5.js";import"./Upload-DVKHQbcn.js";import"./index-BPwFYay9.js";import"./Tag-C5UAaR6R.js";import{A as R}from"./AdaptableCard-DmZKEZU8.js";import"./Views-D-uBkVS-.js";import"./chart.config-DDCNvm2Q.js";import{C as W}from"./ConfirmDialog-D8nWTqJT.js";import"./DataTable-aN3aFI0i.js";import"./SvgIcon-BvWLwctQ.js";import"./SegmentItemOption-Cj0dKbLO.js";import{k as X,o as Z,p as ee,q as te}from"./api-BL3Ea9lB.js";import{f as ae}from"./format-CBpsKyOP.js";import"./StatusIcon-vuYtWMPB.js";import"./CloseButton-CSyekQus.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-MIyuRDz8.js";import"./context-B0dog8SG.js";import"./index-3lctU3d7.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-u5YpxD3p.js";import"./floating-ui.react-K4q-Qtxj.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-0JrmfMFZ.js";import"./_getPrototype-Dk_uG1mG.js";import"./index-CBr4D0uW.js";import"./toString-9EwY3KIP.js";import"./index-Csg7nRTo.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-KN0VPQ3v.js";import"./index-GlPtBqgB.js";import"./useThemeClass-DpghVrlu.js";const se=new Date,V=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"}],$=h.forwardRef((c,n)=>{const{type:p,initialData:l={billType:"mess",billDate:new Date().toISOString().split("T")[0],shop:"",invoiceNumber:"",amount:"",paymentMethod:"",attachments:[]},onFormSubmit:b,onDiscard:y,onDelete:v}=c,[N,A]=h.useState([]),[S,x]=h.useState(!0),[u,s]=h.useState(l.attachments||[]);h.useEffect(()=>{(async()=>{var m,o;try{x(!0);const D=((o=(m=(await X()).data)==null?void 0:m.shops)==null?void 0:o.map(a=>({label:a.shopName,value:a._id})))||[];A(D)}catch(r){console.error("Failed to fetch shops:",r)}finally{x(!1)}})()},[]),h.useEffect(()=>{l.attachments&&s(l.attachments)},[l.attachments]);const w=Y().shape({billDate:B().required("Bill Date is required"),shop:B().required("Shop is required"),paymentMethod:B().required("Payment Method is required"),amount:G().typeError("Amount must be a number").required("Amount is required")}),F=t=>{if(t.target.files&&t.target.files.length>0){const m=Array.from(t.target.files);s(o=>[...o,...m])}},M=t=>{s(m=>m.filter((o,r)=>r!==t))};return e.jsx(H,{innerRef:n,initialValues:{...l,billType:l.billType||"mess",billDate:l.billDate||new Date().toISOString().split("T")[0],shop:l.shopId||l.shop||"",paymentMethod:l.paymentMethod||"",attachments:l.attachments||[],amount:l.amount??""},validationSchema:w,onSubmit:async(t,{setSubmitting:m,setErrors:o})=>{var D;const r=new FormData;r.append("billType",t.billType),r.append("billDate",t.billDate),r.append("shop",t.shop),r.append("paymentMethod",t.paymentMethod),r.append("amount",t.amount.toString()),t.invoiceNumber&&r.append("invoiceNo",t.invoiceNumber),u.forEach((a,d)=>{a instanceof File?r.append("attachments",a):r.append(`existingAttachments[${d}]`,JSON.stringify(a))});try{await b(r,m)}catch(a){m(!1),(D=a.message)!=null&&D.includes("Shop already exists")&&o({shop:"This shop already exists"})}},enableReinitialize:!0,children:({values:t,touched:m,errors:o,isSubmitting:r,setFieldValue:D})=>e.jsx(U,{children:e.jsxs(L,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Bill Type",children:e.jsx(j,{name:"billType",children:({field:a,form:d})=>e.jsx(E,{options:[{label:"Mess",value:"mess"}],value:{label:"Mess",value:"mess"},onChange:i=>d.setFieldValue(a.name,i==null?void 0:i.value),isDisabled:p==="edit"})})}),e.jsx(g,{label:"Bill Date",invalid:!!o.billDate&&m.billDate,children:e.jsx(j,{name:"billDate",children:({field:a,form:d})=>e.jsx(K,{placeholder:"Select billDate Date",value:a.value?new Date(a.value):null,maxDate:se,onChange:i=>d.setFieldValue(a.name,i?ae(new Date(i.getFullYear(),i.getMonth(),i.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(g,{label:"Shop",invalid:!!o.shop&&m.shop,errorMessage:o.shop,children:e.jsx(j,{name:"shop",children:({field:a,form:d})=>{const i=N.find(f=>f.value===a.value)||null;return e.jsx(E,{placeholder:S?"Loading shops...":"Select Shop",options:N,value:i,onChange:f=>d.setFieldValue(a.name,(f==null?void 0:f.value)||""),loading:S})}})}),e.jsx(g,{label:"Payment Method",invalid:!!o.paymentMethod&&m.paymentMethod,errorMessage:o.paymentMethod,children:e.jsx(j,{name:"paymentMethod",children:({field:a,form:d})=>e.jsx(E,{placeholder:"Select Payment Method",options:V,value:V.find(i=>i.value===t.paymentMethod),onChange:i=>d.setFieldValue(a.name,(i==null?void 0:i.value)||"")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Invoice Number",children:e.jsx(j,{type:"text",autoComplete:"off",name:"invoiceNumber",placeholder:"Invoice Number",component:q})}),e.jsx(g,{label:"Amount",invalid:!!o.amount&&m.amount,errorMessage:o.amount,children:e.jsx(j,{name:"amount",children:({field:a,form:d})=>e.jsx(q,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:i=>d.setFieldValue(a.name,i.target.value)})})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(g,{label:"Attachments",children:[e.jsx("input",{type:"file",multiple:!0,onChange:F,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"}),u.length>0&&e.jsx("div",{className:"space-y-2 mt-3",children:u.map((a,d)=>{const i=a instanceof File,f=i?a.name:a.fileName,O=i?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[O?e.jsx("a",{href:O,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:f}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:f}),e.jsx("button",{type:"button",onClick:()=>M(d),className:"text-red-500 hover:text-red-700 ml-2",children:e.jsx(P,{})})]},d)})})]})]})]})}),e.jsxs(J,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:p==="edit"&&v&&e.jsx(ie,{onDelete:v})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(T,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>y==null?void 0:y(),children:"Discard"}),e.jsx(T,{size:"sm",variant:"solid",loading:r,icon:e.jsx(Q,{}),type:"submit",children:"Save"})]})]})]})})})});$.displayName="MessBillForm";const ie=({onDelete:c})=>{const[n,p]=h.useState(!1),l=()=>{p(!1),c==null||c(p)},b=()=>{p(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(P,{}),type:"button",onClick:()=>p(!0),children:"Delete"}),e.jsx(W,{isOpen:n,type:"danger",title:"Delete Bill Entry",confirmButtonColor:"red-600",onClose:b,onRequestClose:b,onCancel:b,onConfirm:l,children:e.jsx("p",{children:"Are you sure you want to delete this bill entry?"})})]})},I={billType:"mess",shopName:"",shopNo:"",invoiceNumber:"",paymentMethod:"",amount:"",attachments:[]},mt=()=>{const c=_(),{id:n}=z(),[p,l]=h.useState(I);console.log(p,"initialData");const[b,y]=h.useState(!!n),[v,N]=h.useState(null);h.useEffect(()=>{if(!n){l(I),y(!1);return}(async()=>{var u;try{y(!0);const s=await Z(n);if(console.log((u=s==null?void 0:s.data)==null?void 0:u.shop,"response"),!(s!=null&&s.data))throw new Error("Invalid bill data received");l({billType:s.data.billType||"mess",shopName:s.data.shop.shopName||"",shopNo:s.data.shop.shopNo||"",shopId:s.data.shop._id||"",invoiceNumber:s.data.invoiceNo||"",paymentMethod:s.data.paymentMethod||"",amount:s.data.amount||"",attachments:s.data.attachments||[]}),N(null)}catch(s){console.error("Error fetching bill:",s),N(s.message||"Failed to load bill data"),k.push(e.jsx(C,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:s.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>c("/app/mess-bill-view"),2500)}finally{y(!1)}})()},[n,c]);const A=async(x,u)=>{var s,w,F,M;try{u(!0);const t=n?await ee(n,x):await te(x);if([200,201].includes(t.status))k.push(e.jsxs(C,{title:`Successfully ${n?"updated":"added"} mess bill`,type:"success",duration:2500,children:["Mess bill ",n?"updated":"added"," successfully"]}),{placement:"top-center"}),c("/app/mess-bill-view");else throw new Error(((w=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:w.message)||"Unexpected status code")}catch(t){console.error("Error during form submission:",t),k.push(e.jsx(C,{title:`Error ${n?"updating":"adding"} mess bill`,type:"danger",duration:2500,children:((M=(F=t==null?void 0:t.response)==null?void 0:F.data)==null?void 0:M.message)||t.message}),{placement:"top-center"})}finally{u(!1)}},S=()=>{JSON.stringify(p)!==JSON.stringify(I)?window.confirm("Are you sure you want to discard changes?")&&c("/app/mess-bill-view"):c("/app/mess-bill-view")};return b?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):v?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(C,{title:"Error loading bill",type:"danger",children:v})}):e.jsx($,{type:n?"edit":"new",initialData:p,onFormSubmit:A,onDiscard:S})};export{mt as default};
