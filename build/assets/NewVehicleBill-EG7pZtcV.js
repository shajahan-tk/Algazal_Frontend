import{r as u,j as e,v as J,ak as U}from"./index-CfFwh--H.js";import{N as T,t as I}from"./toast-CZz_7xZu.js";import{m as Q,k as Y,o as G,p as K,q as W}from"./api-BL2eMQch.js";import{F as X,a as b}from"./FormItem-CrM3E5oZ.js";import{B as O}from"./Button-DK8YG6Vd.js";import{S as Z}from"./StickyFooter-DkUgER91.js";import{F as ee,a as te,b as y}from"./formik.esm-L7JVMBJt.js";import{A as ae}from"./index-rtDifbQS.js";import{$ as _}from"./index-CEOENyZN.js";import{c as ie,h as le,b as S,g as se,e as re,f as ne}from"./index.esm-CDTj4fG4.js";import"./Alert-8oOn-LBQ.js";import"./index-CSFznbuf.js";import"./Badge-Bo_BJ3HY.js";import{D as oe}from"./index-Tb9TnHR2.js";import"./Card-DrR7Wowt.js";import"./Skeleton-CkbmhpF1.js";import"./Dialog-CCGqt-e6.js";import"./Drawer-rdVC219j.js";import"./index-Cqj_MPfk.js";import"./useUniqueId-C3QGMlyo.js";import{I as V}from"./Input-CT3ndZ0a.js";import"./index-e68N8ix-.js";import"./index-DuV_W8Ok.js";import"./index-BhqUyqjr.js";import"./index-DbLmEKzF.js";import"./ScrollBar-BGjE3Qe3.js";import{S as E}from"./Select-DXgitA5g.js";import"./Upload-C3hi9liu.js";import"./index-uPavB4wA.js";import"./Tag-CDky4RgO.js";import{A as P}from"./AdaptableCard-T1jSCi4m.js";import"./Views-DDo_d-60.js";import"./chart.config-46MU3zdR.js";import"./DataTable-B06t5ZtT.js";import"./SvgIcon-r4E3aiGi.js";import"./SegmentItemOption-BO4J9Vay.js";import{f as ce}from"./format-CBpsKyOP.js";import"./StatusIcon-CVY_iJbr.js";import"./CloseButton-BXsrAn2U.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-DVFC3BrG.js";import"./context-ClB8cHxu.js";import"./index-CbqZmROt.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-ByyYtpKF.js";import"./floating-ui.react-DGPs_AnH.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-e9pFJmGN.js";import"./_getPrototype-QbS_EcaU.js";import"./index-C6dvUS2c.js";import"./toString-tgkm5ft3.js";import"./index-DYO9xx5Q.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-LGebAmfn.js";import"./index-WfMoUKkC.js";import"./useThemeClass-Rhgp5cBq.js";const me=new Date,$=[{label:"ADCB",value:"adcb"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"},{label:"ATHEER PLUS",value:"atheer_plus"}],L=u.forwardRef((g,d)=>{const{type:k,initialData:o={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},onFormSubmit:q,onDiscard:j,onDelete:w}=g,[N,F]=u.useState([]),[A,M]=u.useState([]),[m,c]=u.useState([]),[D,B]=u.useState(!0);u.useEffect(()=>{o.attachments&&F(o.attachments)},[o]),u.useEffect(()=>{(async()=>{var s,i,f;try{const v=await Q(),r=(s=v==null?void 0:v.data)==null?void 0:s.vehicles.map(a=>({label:a.vehicleNumber,value:a._id}));M(r||[]);const n=((f=(i=(await Y()).data)==null?void 0:i.shops)==null?void 0:f.map(a=>({label:a.shopName,value:a._id})))||[];c(n)}catch(v){console.error("Failed to load data:",v)}finally{B(!1)}})()},[]);const C=ie().shape({billType:S().required("Bill type is required"),billDate:ne().required("Bill date is required").typeError("Please select a valid date"),purpose:S().required("Purpose is required"),vehicles:re().of(S()).min(1,"At least one vehicle must be selected").required("Vehicle selection is required"),paymentMethod:S().required("Payment method is required"),amount:se().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),shop:S().required("Shop is required"),remarks:S().max(500,"Remarks must be at most 500 characters"),attachments:le()}),p=l=>{if(l.target.files&&l.target.files.length>0){const s=Array.from(l.target.files);F(i=>[...i,...s])}},z=l=>{F(s=>s.filter((i,f)=>f!==l))},H=()=>({billType:o.billType,billDate:o.billDate,purpose:o.purpose,vehicles:o.vehicles.map(l=>l._id),invoiceNo:o.invoiceNo,paymentMethod:o.paymentMethod,amount:o.amount,shop:o.shop._id,remarks:o.remarks,attachments:o.attachments});return e.jsx(ee,{innerRef:d,initialValues:H(),validationSchema:C,onSubmit:async(l,{setSubmitting:s,setErrors:i})=>{var f,v;try{const r=new FormData;r.append("billType",l.billType),r.append("billDate",l.billDate),r.append("purpose",l.purpose),l.vehicles.forEach(t=>{r.append("vehicles[]",t)}),r.append("invoiceNo",l.invoiceNo),r.append("paymentMethod",l.paymentMethod),r.append("amount",l.amount.toString()),r.append("shop",l.shop),r.append("remarks",l.remarks||""),N.forEach((t,n)=>{t instanceof File?r.append("attachments",t):typeof t=="string"&&k==="edit"&&r.append(`existingAttachments[${n}]`,t)}),await q(r,s)}catch(r){s(!1),(v=(f=r.response)==null?void 0:f.data)!=null&&v.errors&&i(r.response.data.errors),console.error("Form submission error:",r)}},enableReinitialize:!0,children:({values:l,touched:s,errors:i,isSubmitting:f,setFieldValue:v,handleBlur:r})=>e.jsx(te,{children:e.jsxs(X,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Vehicle Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(b,{label:"Bill Type",invalid:!!i.billType&&s.billType,errorMessage:i.billType,children:e.jsx(y,{name:"billType",children:({field:t,form:n})=>{const a=[{label:"Vehicle",value:"vehicle",disabled:!0}],h=a.find(x=>x.value===t.value)||a[0];return e.jsx(E,{options:a,value:h,isOptionDisabled:x=>x.disabled,onChange:x=>{n.setFieldValue(t.name,x==null?void 0:x.value)},onBlur:t.onBlur,name:t.name})}})}),e.jsx(b,{label:"Bill Date",invalid:!!i.billDate&&s.billDate,children:e.jsx(y,{name:"billDate",children:({field:t,form:n})=>e.jsx(oe,{placeholder:"Select billDate Date",value:t.value?new Date(t.value):null,maxDate:me,onChange:a=>n.setFieldValue(t.name,a?ce(new Date(a.getFullYear(),a.getMonth(),a.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(b,{label:"Purpose",invalid:!!i.purpose&&s.purpose,errorMessage:i.purpose,children:e.jsx(y,{name:"purpose",children:({field:t})=>e.jsx(V,{type:"text",autoComplete:"off",placeholder:"Purpose",...t})})}),e.jsx(b,{label:"Vehicle",invalid:!!i.vehicles&&s.vehicles,errorMessage:i.vehicles,children:e.jsx(y,{name:"vehicles",children:({field:t,form:n})=>e.jsx(E,{placeholder:"Select Vehicle(s)",options:A,isMulti:!0,value:A.filter(a=>l.vehicles.includes(a.value)),onChange:a=>{const h=a?a.map(x=>x.value):[];n.setFieldValue(t.name,h)},onBlur:t.onBlur,loading:D})})}),e.jsx(b,{label:"Invoice No",invalid:!!i.invoiceNo&&s.invoiceNo,errorMessage:i.invoiceNo,children:e.jsx(y,{name:"invoiceNo",children:({field:t})=>e.jsx(V,{type:"text",autoComplete:"off",placeholder:"Invoice number",...t})})}),e.jsx(b,{label:"Payment Method",invalid:!!i.paymentMethod&&s.paymentMethod,errorMessage:i.paymentMethod,children:e.jsx(y,{name:"paymentMethod",children:({field:t,form:n})=>e.jsx(E,{placeholder:"Select Payment Method",options:$,value:$.find(a=>a.value===l.paymentMethod),onChange:a=>{n.setFieldValue(t.name,(a==null?void 0:a.value)||"")},onBlur:t.onBlur})})}),e.jsx(b,{label:"Amount",invalid:!!i.amount&&s.amount,errorMessage:i.amount,children:e.jsx(y,{name:"amount",children:({field:t,form:n})=>e.jsx(V,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:a=>{n.setFieldValue(t.name,a.target.value)}})})}),e.jsx(b,{label:"Shop",invalid:!!i.shop&&s.shop,errorMessage:i.shop,children:e.jsx(y,{name:"shop",children:({field:t,form:n})=>{const a=m.find(h=>h.value===t.value)||null;return e.jsx(E,{placeholder:D?"Loading shops...":"Select Shop",options:m,value:a,onChange:h=>n.setFieldValue(t.name,(h==null?void 0:h.value)||""),loading:D})}})})]})]}),e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(b,{label:"Attachments",invalid:!!i.attachments&&s.attachments,errorMessage:i.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:p,onBlur:()=>r({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),N.length>0&&e.jsx("div",{className:"space-y-2",children:N.map((t,n)=>{let a,h;return t instanceof File?a=t.name:typeof t=="object"&&t!==null?(a=t.fileName||t.filePath||"Attachment",h=t._id):typeof t=="string"?a=t:a="Attachment",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:a}),e.jsx("button",{type:"button",onClick:()=>z(n),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(_,{})})]},h||n)})})]})]}),e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(b,{label:"Remarks",invalid:!!i.remarks&&s.remarks,errorMessage:i.remarks,children:e.jsx(y,{name:"remarks",children:({field:t})=>e.jsx(V,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...t})})})]})]})}),e.jsxs(Z,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:k==="edit"&&w&&e.jsx(O,{size:"sm",variant:"plain",color:"red",icon:e.jsx(_,{}),type:"button",onClick:()=>w(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(O,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(O,{size:"sm",variant:"solid",loading:f,icon:e.jsx(ae,{}),type:"submit",children:"Save"})]})]})]})})})});L.displayName="VehicleBillForm";const R={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},ut=()=>{const g=J(),{id:d}=U(),[k,o]=u.useState(R),[q,j]=u.useState(!!d),[w,N]=u.useState(null);u.useEffect(()=>{if(!d){o(R),j(!1);return}(async()=>{try{j(!0);const m=await G(d);if(!(m!=null&&m.data))throw new Error("Invalid bill data received");const{data:c}=m;o({billType:c.billType||"vehicle",billDate:c.billDate?c.billDate.split("T")[0]:new Date().toISOString().split("T")[0],purpose:c.purpose||"",vehicles:c.vehicles||[],invoiceNo:c.invoiceNo||"",paymentMethod:c.paymentMethod||"",amount:c.amount||0,shop:c.shop||{_id:"",shopName:"",shopNo:""},remarks:c.remarks||"",attachments:c.attachments||[]}),N(null)}catch(m){console.error("Error fetching bill:",m),N(m.message||"Failed to load bill data"),I.push(e.jsx(T,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:m.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>g("/app/vehicle-bill-view"),2500)}finally{j(!1)}})()},[d,g]);const F=async(M,m)=>{var c,D,B,C;try{m(!0);const p=d?await K(d,M):await W(M);if([200,201].includes(p.status))I.push(e.jsxs(T,{title:`Successfully ${d?"updated":"added"} vehicle bill`,type:"success",duration:2500,children:["Vehicle bill ",d?"updated":"added"," successfully"]}),{placement:"top-center"}),g("/app/vehicle-bill-view");else throw new Error(((D=(c=p==null?void 0:p.response)==null?void 0:c.data)==null?void 0:D.message)||"Unexpected status code")}catch(p){console.error("Error during form submission:",p),I.push(e.jsx(T,{title:`Error ${d?"updating":"adding"} vehicle bill`,type:"danger",duration:2500,children:((C=(B=p==null?void 0:p.response)==null?void 0:B.data)==null?void 0:C.message)||p.message}),{placement:"top-center"})}finally{m(!1)}},A=()=>{JSON.stringify(k)!==JSON.stringify(R)?window.confirm("Are you sure you want to discard changes?")&&g("/app/vehicle-bill-view"):g("/app/vehicle-bill-view")};return q?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):w?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(T,{title:"Error loading vehicle bill",type:"danger",children:w})}):e.jsx(L,{type:d?"edit":"new",initialData:k,onFormSubmit:F,onDiscard:A})};export{ut as default};
