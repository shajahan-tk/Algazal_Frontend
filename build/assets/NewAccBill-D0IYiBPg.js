import{r as h,j as e,v as _,ak as z}from"./index-DrziBPhZ.js";import{N as C,t as E}from"./toast-ClnWKBBo.js";import{F as L,a as f}from"./FormItem-Cku4jOg1.js";import{B as R}from"./Button-DG2-jqZG.js";import{S as J}from"./StickyFooter-RWxGWKXo.js";import{F as H,a as U,b as g}from"./formik.esm-CPLrydYm.js";import{A as Q}from"./index-CBDs7g4_.js";import{$ as P}from"./index-Ds8t50Me.js";import{c as Y,g as G,b as M}from"./index.esm-BB-UMuCJ.js";import"./Alert-BLGo7HyM.js";import"./index-yw21U4bP.js";import"./Badge-C2KmHilm.js";import{D as K}from"./index-BmalSfvl.js";import"./Card-nlnRLrlQ.js";import"./Skeleton-C2woZuKJ.js";import"./Dialog-D7FxUuyk.js";import"./Drawer-IABuvwPK.js";import"./index-8tDMqpHX.js";import"./useUniqueId-B25XPIVz.js";import{I as D}from"./Input-B4wHBRkW.js";import"./index-DKNJHN__.js";import"./index-ChB5CpHQ.js";import"./index-DN1w59Ps.js";import"./index-Cv7sYzj3.js";import"./ScrollBar-CAweRmRR.js";import{S as T}from"./Select-nm3Sb7o5.js";import"./Upload-DVKHQbcn.js";import"./index-BPwFYay9.js";import"./Tag-C5UAaR6R.js";import{A as O}from"./AdaptableCard-DmZKEZU8.js";import"./Views-D-uBkVS-.js";import"./chart.config-DDCNvm2Q.js";import{C as W}from"./ConfirmDialog-D8nWTqJT.js";import"./DataTable-aN3aFI0i.js";import"./SvgIcon-BvWLwctQ.js";import"./SegmentItemOption-Cj0dKbLO.js";import{k as X,o as Z,p as ee,q as te}from"./api-BL3Ea9lB.js";import{f as ae}from"./format-CBpsKyOP.js";import"./StatusIcon-vuYtWMPB.js";import"./CloseButton-CSyekQus.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-MIyuRDz8.js";import"./context-B0dog8SG.js";import"./index-3lctU3d7.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-u5YpxD3p.js";import"./floating-ui.react-K4q-Qtxj.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-0JrmfMFZ.js";import"./_getPrototype-Dk_uG1mG.js";import"./index-CBr4D0uW.js";import"./toString-9EwY3KIP.js";import"./index-Csg7nRTo.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-KN0VPQ3v.js";import"./index-GlPtBqgB.js";import"./useThemeClass-DpghVrlu.js";const oe=new Date,V=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"}],$=h.forwardRef((c,d)=>{const{type:u,initialData:s={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",amount:"",paymentMethod:"",note:"",remarks:"",attachments:[]},onFormSubmit:y,onDiscard:N,onDelete:v}=c,[S,B]=h.useState([]),[A,j]=h.useState(!0),[b,x]=h.useState(s.attachments||[]);h.useEffect(()=>{(async()=>{var n,l;try{j(!0);const w=((l=(n=(await X()).data)==null?void 0:n.shops)==null?void 0:l.map(a=>({label:a.shopName,value:a._id})))||[];B(w)}catch(i){console.error("Failed to fetch shops:",i)}finally{j(!1)}})()},[]),h.useEffect(()=>{s.attachments&&x(s.attachments)},[s.attachments]);const o=Y().shape({date:M().required("Date is required"),shopName:M().required("Shop Name is required"),roomNo:M().required("Room No is required"),paymentMethod:M().required("Payment Method is required"),amount:G().typeError("Amount must be a number").required("Amount is required")}),F=t=>{if(t.target.files&&t.target.files.length>0){const n=Array.from(t.target.files);x(l=>[...l,...n])}},k=t=>{x(n=>n.filter((l,i)=>i!==t))};return e.jsx(H,{innerRef:d,initialValues:{...s,billType:s.billType||"accommodation",date:s.date||new Date().toISOString().split("T")[0],shopName:s.shopName||"",shopId:s.shopId||"",roomNo:s.roomNo||"",paymentMethod:s.paymentMethod||"",note:s.note||"",remarks:s.remarks||"",attachments:s.attachments||[],amount:s.amount??""},validationSchema:o,onSubmit:async(t,{setSubmitting:n,setErrors:l})=>{var w;const i=new FormData;i.append("billType",t.billType),i.append("billDate",t.date),i.append("shopName",t.shopName),t.shopId&&i.append("shop",t.shopId),i.append("roomNo",t.roomNo),i.append("paymentMethod",t.paymentMethod),i.append("amount",t.amount.toString()),t.invoiceNumber&&i.append("invoiceNo",t.invoiceNumber),t.note&&i.append("note",t.note),t.remarks&&i.append("remarks",t.remarks),b.forEach((a,m)=>{a instanceof File?i.append("attachments",a):i.append(`existingAttachments[${m}]`,JSON.stringify(a))});try{await y(i,n)}catch(a){n(!1),(w=a.message)!=null&&w.includes("Shop already exists")&&l({shopName:"This shop already exists"})}},enableReinitialize:!0,children:({values:t,touched:n,errors:l,isSubmitting:i,setFieldValue:w})=>e.jsx(U,{children:e.jsxs(L,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Accommodation Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(f,{label:"Bill Type",children:e.jsx(g,{name:"billType",children:({field:a,form:m})=>e.jsx(T,{options:[{label:"Accommodation",value:"accommodation"}],value:{label:"Accommodation",value:"accommodation"},onChange:r=>m.setFieldValue(a.name,r==null?void 0:r.value),isDisabled:u==="edit"})})}),e.jsx(f,{label:"Bill Date",invalid:!!l.billDate&&n.billDate,children:e.jsx(g,{name:"billDate",children:({field:a,form:m})=>e.jsx(K,{placeholder:"Select bill Date",value:a.value?new Date(a.value):null,maxDate:oe,onChange:r=>m.setFieldValue(a.name,r?ae(new Date(r.getFullYear(),r.getMonth(),r.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(f,{label:"Shop Name",invalid:!!l.shopName&&n.shopName,errorMessage:l.shopName,children:e.jsx(g,{name:"shopName",children:({field:a,form:m})=>{const r=S.find(p=>p.label===a.value)||null;return e.jsx(T,{placeholder:A?"Loading shops...":"Select Shop",options:S,value:r,onChange:p=>{m.setFieldValue(a.name,(p==null?void 0:p.label)||""),m.setFieldValue("shopId",(p==null?void 0:p.value)||"")},loading:A})}})}),e.jsx(f,{label:"Room No",invalid:!!l.roomNo&&n.roomNo,errorMessage:l.roomNo,children:e.jsx(g,{type:"text",autoComplete:"off",name:"roomNo",placeholder:"Room No",component:D})}),e.jsx(f,{label:"Payment Method",invalid:!!l.paymentMethod&&n.paymentMethod,errorMessage:l.paymentMethod,children:e.jsx(g,{name:"paymentMethod",children:({field:a,form:m})=>e.jsx(T,{placeholder:"Select Payment Method",options:V,value:V.find(r=>r.value===t.paymentMethod),onChange:r=>m.setFieldValue(a.name,(r==null?void 0:r.value)||"")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(f,{label:"Invoice Number",children:e.jsx(g,{type:"text",autoComplete:"off",name:"invoiceNumber",placeholder:"Invoice Number",component:D})}),e.jsx(f,{label:"Amount",invalid:!!l.amount&&n.amount,errorMessage:l.amount,children:e.jsx(g,{name:"amount",children:({field:a,form:m})=>e.jsx(D,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:r=>m.setFieldValue(a.name,r.target.value)})})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsx(f,{label:"Note",children:e.jsx(g,{as:"textarea",autoComplete:"off",name:"note",placeholder:"Note",component:D,textArea:!0})})})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(f,{label:"Attachments",children:[e.jsx("input",{type:"file",multiple:!0,onChange:F,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"}),b.length>0&&e.jsx("div",{className:"space-y-2 mt-3",children:b.map((a,m)=>{const r=a instanceof File,p=r?a.name:a.fileName,q=r?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[q?e.jsx("a",{href:q,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:p}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:p}),e.jsx("button",{type:"button",onClick:()=>k(m),className:"text-red-500 hover:text-red-700 ml-2",children:e.jsx(P,{})})]},m)})})]})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(f,{label:"Remarks",children:e.jsx(g,{as:"textarea",autoComplete:"off",name:"remarks",placeholder:"Remarks",component:D,textArea:!0})})]})]})}),e.jsxs(J,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:u==="edit"&&v&&e.jsx(re,{onDelete:v})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(R,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>N==null?void 0:N(),children:"Discard"}),e.jsx(R,{size:"sm",variant:"solid",loading:i,icon:e.jsx(Q,{}),type:"submit",children:"Save"})]})]})]})})})});$.displayName="AccBillForm";const re=({onDelete:c})=>{const[d,u]=h.useState(!1),s=()=>{u(!1),c==null||c(u)},y=()=>{u(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(P,{}),type:"button",onClick:()=>u(!0),children:"Delete"}),e.jsx(W,{isOpen:d,type:"danger",title:"Delete Accommodation Bill",confirmButtonColor:"red-600",onClose:y,onRequestClose:y,onCancel:y,onConfirm:s,children:e.jsx("p",{children:"Are you sure you want to delete this accommodation bill?"})})]})},I={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",paymentMethod:"",amount:"",note:"",remarks:"",attachments:[]},mt=()=>{const c=_(),{id:d}=z(),[u,s]=h.useState(I),[y,N]=h.useState(!!d),[v,S]=h.useState(null);h.useEffect(()=>{if(!d){s(I),N(!1);return}(async()=>{var b,x;try{N(!0);const o=await Z(d);if(!(o!=null&&o.data))throw new Error("Invalid bill data received");s({billType:o.data.billType||"accommodation",date:o.data.date||I.date,shopName:((b=o.data.shop)==null?void 0:b.shopName)||"",roomNo:o.data.roomNo||"",shopId:((x=o.data.shop)==null?void 0:x._id)||"",invoiceNumber:o.data.invoiceNo||"",paymentMethod:o.data.paymentMethod||"",amount:o.data.amount||"",note:o.data.note||"",remarks:o.data.remarks||"",attachments:o.data.attachments||[]}),S(null)}catch(o){console.error("Error fetching bill:",o),S(o.message||"Failed to load bill data"),E.push(e.jsx(C,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:o.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>c("/app/acc-bill-view"),2500)}finally{N(!1)}})()},[d,c]);const B=async(j,b)=>{var x,o,F,k;try{b(!0);const t=d?await ee(d,j):await te(j);if([200,201].includes(t.status))E.push(e.jsxs(C,{title:`Successfully ${d?"updated":"added"} accommodation bill`,type:"success",duration:2500,children:["Accommodation bill ",d?"updated":"added"," successfully"]}),{placement:"top-center"}),c("/app/acc-bill-view");else throw new Error(((o=(x=t==null?void 0:t.response)==null?void 0:x.data)==null?void 0:o.message)||"Unexpected status code")}catch(t){console.error("Error during form submission:",t),E.push(e.jsx(C,{title:`Error ${d?"updating":"adding"} accommodation bill`,type:"danger",duration:2500,children:((k=(F=t==null?void 0:t.response)==null?void 0:F.data)==null?void 0:k.message)||t.message}),{placement:"top-center"})}finally{b(!1)}},A=()=>{JSON.stringify(u)!==JSON.stringify(I)?window.confirm("Are you sure you want to discard changes?")&&c("/app/acc-bill-view"):c("/app/acc-bill-view")};return y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):v?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(C,{title:"Error loading bill",type:"danger",children:v})}):e.jsx($,{type:d?"edit":"new",initialData:u,onFormSubmit:B,onDiscard:A})};export{mt as default};
