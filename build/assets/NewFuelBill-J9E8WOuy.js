import{r as p,j as e,v as K,ak as z}from"./index-B-3YdMmO.js";import{N as E,t as q}from"./toast-xjy4rp4Y.js";import{m as H,o as J,p as U,q as Q}from"./api-C4nUkZdB.js";import{F as Y,a as c}from"./FormItem-B_dHMuui.js";import{B as I}from"./Button-CfVbO-qU.js";import{S as G}from"./StickyFooter-kVZ9pP5X.js";import{F as W,a as X,b as u}from"./formik.esm-DIqlYRh2.js";import{A as Z}from"./index-of15F68n.js";import{$ as P}from"./index-C7R1WpOH.js";import{c as ee,h as te,b as w,g as V,f as ae}from"./index.esm-uYrHGYFJ.js";import"./Alert-QJLDMk5I.js";import"./index-Bo39LFtR.js";import"./Badge-B2PjptLi.js";import{D as ie}from"./index-DCFjNNBJ.js";import"./Card-Dg6B2cp2.js";import"./Skeleton-C9LsrBBE.js";import"./Dialog-DSC5KQx1.js";import"./Drawer-CIBw5hlm.js";import"./index-DVAakj00.js";import"./useUniqueId-bhrNi0MA.js";import{I as S}from"./Input-m_H_R88b.js";import"./index-B_Yvn3dy.js";import"./index-Z4dDP0Pn.js";import"./index-BdrlLZgj.js";import"./index-5z68-iaN.js";import"./ScrollBar-C_iOIJGq.js";import{S as O}from"./Select-DPSULLBa.js";import"./Upload-CuAXzTtV.js";import"./index-CqQ94ycg.js";import"./Tag-D_vNYl-M.js";import{A as R}from"./AdaptableCard-17ILPCDG.js";import"./Views-o_SZwizf.js";import"./chart.config-Cux27phG.js";import"./DataTable-CxfAxHEh.js";import"./SvgIcon-BC1C4FwK.js";import"./SegmentItemOption-CxYE_tKh.js";import{f as le}from"./format-CBpsKyOP.js";import"./StatusIcon-IxYTyNOx.js";import"./CloseButton-8arYtbYT.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-nPFZIZ0Z.js";import"./context-_TTgW2bZ.js";import"./index-Dhg3PmVb.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-VlwWE1Gk.js";import"./floating-ui.react-l_cC_yYr.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useControllableState-HmMJSzbR.js";import"./_getPrototype-BJeMep-l.js";import"./index-BL9xzUQn.js";import"./toString-B2j7ZGf1.js";import"./index-CYY49BFP.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./index-BLqgq88H.js";import"./index-BYLbIXHY.js";import"./useThemeClass-BEUnEzZK.js";const re=new Date,$=[{label:"ADCB",value:"adcb"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"},{label:"ATHEER PLUS ",value:"atheer_plus"}],_=p.forwardRef((b,d)=>{const{type:k,initialData:m={billType:"fuel",billDate:new Date().toISOString().split("T")[0],description:"",vehicleNo:"",paymentMethod:"",amount:0,kilometer:0,liter:0,remarks:"",attachments:[]},onFormSubmit:T,onDiscard:f,onDelete:N}=b,[v,D]=p.useState([]),[M,F]=p.useState([]),[y,x]=p.useState(!0);p.useEffect(()=>{m.attachments&&D(m.attachments)},[m]),p.useEffect(()=>{(async()=>{var s;try{const l=await H(),h=(s=l==null?void 0:l.data)==null?void 0:s.vehicles.map(j=>({label:j.vehicleNumber,value:j._id}));F(h||[])}catch(l){console.error("Failed to load data:",l)}finally{x(!1)}})()},[]);const r=ee().shape({billType:w().required("Bill type is required"),billDate:ae().required("Bill date is required").typeError("Please select a valid date"),description:w().required("Description is required"),vehicleNo:w().required("Vehicle number is required"),paymentMethod:w().required("Payment method is required"),amount:V().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),kilometer:V().required("Kilometer reading is required").positive("Kilometer must be positive").typeError("Kilometer must be a number"),liter:V().required("Liter is required").positive("Liter must be positive").typeError("Liter must be a number"),remarks:w().max(500,"Remarks must be at most 500 characters"),attachments:te()}),A=i=>{if(i.target.files&&i.target.files.length>0){const s=Array.from(i.target.files);D(l=>[...l,...s])}},B=i=>{D(s=>s.filter((l,h)=>h!==i))};return e.jsx(W,{innerRef:d,initialValues:{billType:m.billType||"fuel",billDate:m.billDate||"",description:m.description||"",vehicleNo:m.vehicleId||m.vehicleNo||"",paymentMethod:m.paymentMethod||"",amount:m.amount||"",kilometer:m.kilometer||"",liter:m.liter||"",remarks:m.remarks||"",attachments:m.attachments||[]},validationSchema:r,onSubmit:async(i,{setSubmitting:s,setErrors:l})=>{var h,j;try{const n=new FormData;n.append("billType",i.billType),n.append("billDate",i.billDate),n.append("description",i.description),n.append("vehicle",i.vehicleNo),n.append("paymentMethod",i.paymentMethod),n.append("amount",i.amount.toString()),n.append("kilometer",i.kilometer.toString()),n.append("liter",i.liter.toString()),n.append("remarks",i.remarks||""),v.forEach((t,o)=>{t instanceof File?n.append("attachments",t):typeof t=="string"&&k==="edit"&&n.append(`existingAttachments[${o}]`,t)}),await T(n,s)}catch(n){s(!1),(j=(h=n.response)==null?void 0:h.data)!=null&&j.errors&&l(n.response.data.errors),console.error("Form submission error:",n)}},enableReinitialize:!0,children:({values:i,touched:s,errors:l,isSubmitting:h,setFieldValue:j,handleBlur:n})=>e.jsx(X,{children:e.jsxs(Y,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Fuel Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"Bill Type",invalid:!!l.billType&&s.billType,errorMessage:l.billType,children:e.jsx(u,{name:"billType",children:({field:t,form:o})=>{const a=[{label:"Fuel",value:"fuel",disabled:!0}],C=a.find(g=>g.value===t.value)||a[0];return e.jsx(O,{options:a,value:C,isOptionDisabled:g=>g.disabled,onChange:g=>{o.setFieldValue(t.name,g==null?void 0:g.value)},onBlur:t.onBlur,name:t.name})}})}),e.jsx(c,{label:"Bill Date",invalid:!!l.billDate&&s.billDate,children:e.jsx(u,{name:"billDate",children:({field:t,form:o})=>e.jsx(ie,{placeholder:"Select bill Date",value:t.value?new Date(t.value):null,maxDate:re,onChange:a=>o.setFieldValue(t.name,a?le(new Date(a.getFullYear(),a.getMonth(),a.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(c,{label:"Description",invalid:!!l.description&&s.description,errorMessage:l.description,children:e.jsx(u,{name:"description",children:({field:t})=>e.jsx(S,{type:"text",autoComplete:"off",placeholder:"Description",...t})})}),e.jsx(c,{label:"Vehicle No",invalid:!!l.vehicleNo&&s.vehicleNo,errorMessage:l.vehicleNo,children:e.jsx(u,{name:"vehicleNo",children:({field:t,form:o})=>e.jsx(O,{placeholder:"Select Vehicle Number",options:M,value:M.find(a=>a.value===i.vehicleNo),onChange:a=>{o.setFieldValue(t.name,(a==null?void 0:a.value)||"")},onBlur:t.onBlur,loading:y})})}),e.jsx(c,{label:"Payment Method",invalid:!!l.paymentMethod&&s.paymentMethod,errorMessage:l.paymentMethod,children:e.jsx(u,{name:"paymentMethod",children:({field:t,form:o})=>e.jsx(O,{placeholder:"Select Payment Method",options:$,value:$.find(a=>a.value===i.paymentMethod),onChange:a=>{o.setFieldValue(t.name,(a==null?void 0:a.value)||"")},onBlur:t.onBlur})})}),e.jsx(c,{label:"Amount",invalid:!!l.amount&&s.amount,errorMessage:l.amount,children:e.jsx(u,{name:"amount",children:({field:t,form:o})=>e.jsx(S,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:a=>{o.setFieldValue(t.name,a.target.value)}})})}),e.jsx(c,{label:"Kilometer",invalid:!!l.kilometer&&s.kilometer,errorMessage:l.kilometer,children:e.jsx(u,{name:"kilometer",children:({field:t,form:o})=>e.jsx(S,{type:"number",autoComplete:"off",placeholder:"Kilometer Reading",...t,onChange:a=>{o.setFieldValue(t.name,a.target.value)}})})}),e.jsx(c,{label:"Liter",invalid:!!l.liter&&s.liter,errorMessage:l.liter,children:e.jsx(u,{name:"liter",children:({field:t,form:o})=>e.jsx(S,{type:"number",autoComplete:"off",placeholder:"Liter",...t,onChange:a=>{o.setFieldValue(t.name,a.target.value)}})})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(c,{label:"Attachments",invalid:!!l.attachments&&s.attachments,errorMessage:l.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:A,onBlur:()=>n({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),v.length>0&&e.jsx("div",{className:"space-y-2",children:v.map((t,o)=>{let a,C;return t instanceof File?a=t.name:typeof t=="object"&&t!==null?(a=t.fileName||t.filePath||"Attachment",C=t._id):typeof t=="string"?a=t:a="Attachment",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:a}),e.jsx("button",{type:"button",onClick:()=>B(o),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(P,{})})]},C||o)})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(c,{label:"Remarks",invalid:!!l.remarks&&s.remarks,errorMessage:l.remarks,children:e.jsx(u,{name:"remarks",children:({field:t})=>e.jsx(S,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...t})})})]})]})}),e.jsxs(G,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:k==="edit"&&N&&e.jsx(I,{size:"sm",variant:"plain",color:"red",icon:e.jsx(P,{}),type:"button",onClick:()=>N(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(I,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>f==null?void 0:f(),children:"Discard"}),e.jsx(I,{size:"sm",variant:"solid",loading:h,icon:e.jsx(Z,{}),type:"submit",children:"Save"})]})]})]})})})});_.displayName="FuelBillForm";const L={billType:"fuel",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,description:"",vehicleNo:"",kilometer:0,liter:0,remarks:"",attachments:[]},mt=()=>{const b=K(),{id:d}=z(),[k,m]=p.useState(L),[T,f]=p.useState(!!d),[N,v]=p.useState(null);p.useEffect(()=>{if(!d){m(L),f(!1);return}(async()=>{var y,x;try{f(!0);const r=await J(d);if(!(r!=null&&r.data))throw new Error("Invalid bill data received");m({billType:r.data.billType||"fuel",billDate:r.data.billDate||new Date().toISOString().split("T")[0],paymentMethod:r.data.paymentMethod||"",amount:r.data.amount||0,description:r.data.description||"",vehicleNo:((y=r.data.vehicle)==null?void 0:y.vehicleNumber)||"",vehicleId:((x=r.data.vehicle)==null?void 0:x._id)||"",kilometer:r.data.kilometer||0,liter:r.data.liter||0,remarks:r.data.remarks||"",attachments:r.data.attachments||[]}),v(null)}catch(r){console.error("Error fetching bill:",r),v(r.message||"Failed to load bill data"),q.push(e.jsx(E,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:r.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>b("/app/fuel-bill-view"),2500)}finally{f(!1)}})()},[d,b]);const D=async(F,y)=>{var x,r,A,B;try{y(!0);const i=d?await U(d,F):await Q(F);if([200,201].includes(i.status))q.push(e.jsxs(E,{title:`Successfully ${d?"updated":"added"} fuel bill`,type:"success",duration:2500,children:["Fuel bill ",d?"updated":"added"," successfully"]}),{placement:"top-center"}),b("/app/fuel-bill-view");else throw new Error(((r=(x=i==null?void 0:i.response)==null?void 0:x.data)==null?void 0:r.message)||"Unexpected status code")}catch(i){console.error("Error during form submission:",i),q.push(e.jsx(E,{title:`Error ${d?"updating":"adding"} fuel bill`,type:"danger",duration:2500,children:((B=(A=i==null?void 0:i.response)==null?void 0:A.data)==null?void 0:B.message)||i.message}),{placement:"top-center"})}finally{y(!1)}},M=()=>{JSON.stringify(k)!==JSON.stringify(L)?window.confirm("Are you sure you want to discard changes?")&&b("/app/fuel-bill-view"):b("/app/fuel-bill-view")};return T?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):N?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(E,{title:"Error loading fuel bill",type:"danger",children:N})}):e.jsx(_,{type:d?"edit":"new",initialData:k,onFormSubmit:D,onDiscard:M})};export{mt as default};
